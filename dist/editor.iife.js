var iife=function(e){"use strict";class t{static canCompareTypes(e){return e===n.TYPE_NUMBER||(e===n.TYPE_DATE||(e===n.TYPE_STRING||(e===n.TYPE_BOOLEAN||(e===n.TYPE_ARRAY||e===n.TYPE_OBJECT))))}static isEqual(e,r){if(n.isDate(e)&&n.isDate(r))return e.getTime()===r.getTime();if(n.isArray(e)&&n.isArray(r)){if(e.length!==r.length)return!1;let n=0;for(const s of e)if(!t.isEqual(s,r[n++]))return!1;return!0}if(n.isObject(e)&&n.isObject(r)){const n=Object.keys(e),s=Object.keys(r);if(n.length!==s.length)return!1;let i=0;for(const a of n){if(!t.isEqual(a,s[i]))return!1;if(!t.isEqual(e[a],r[s[i]]))return!1;i++}return!0}return!(!n.isNaN(e)||!n.isNaN(r))||e===r}static isGreater(e,t){const r=n.getType(e),s=n.getType(t);if(r===s&&this.canCompareTypes(r)){if(r===n.TYPE_ARRAY){let r=0;for(const n of e){if(t.length<r+1)return!0;if(!this.isEqual(n,t[r]))return this.isGreater(n,t[r]);r++}return!1}if(r===n.TYPE_OBJECT){const r=Object.keys(e),n=Object.keys(t);let s=0;for(const i of r){if(n.length<s+1)return!0;if(!this.isEqual(i,n[s]))return this.isGreater(i,n[s]);if(!this.isEqual(e[i],t[n[s]]))return this.isGreater(e[i],t[n[s]]);s++}return!1}return!(n.isNaN(e)||!n.isNaN(t))||e>t}{const e=[n.TYPE_NULL,n.TYPE_NUMBER,n.TYPE_STRING,n.TYPE_OBJECT,n.TYPE_ARRAY,n.TYPE_BOOLEAN,n.TYPE_DATE];return e.indexOf(r)>e.indexOf(s)}}static isLess(e,t){return!this.isEqual(e,t)&&!this.isGreater(e,t)}}class r{static toBoolean(e){return n.isBoolean(e)?e:n.isNumber(e)?!n.isZero(e):n.isString(e)?""!==e:!!n.isObject(e)||(!!n.isArray(e)||!!n.isDate(e))}static toNumber(e){if(n.isString(e)){if(""===e)throw new Error("convert4");if("+infinity"===e.toLowerCase()||"infinity"===e.toLowerCase())return 1/0;if("+inf"===e.toLowerCase()||"inf"===e.toLowerCase())return 1/0;if("-infinity"===e.toLowerCase()||"-inf"===e.toLowerCase())return-1/0;if("nan"===e.toLowerCase())return NaN;if(e.match(/^[+-]?\d+\.?\d*(e[+-]?\d+)?$/i)){const t=parseFloat(e);if(Math.abs(t)>n.DOUBLE_RANGE)throw new Error("convert6");return t}throw new Error("convert5")}if(n.isBoolean(e))return e?1:0;if(n.isNumber(e))return e;if(n.isNull(e))return 0;if(n.isDate(e))return e.getTime();throw new Error("convert1 :: "+n.getType(e)+",number")}static toString(e){if(n.isString(e))return e;if(n.isBoolean(e))return e?"true":"false";if(n.isNumber(e))return e.toString();if(n.isNull(e))return"";if(n.isDate(e)){const t=e.getUTCFullYear();if(t>9999||t<0)throw new Error("convert2 :: "+t);return e.toISOString()}throw new Error("convert1 :: "+n.getType(e)+",string")}static toDate(e){if(n.isDate(e))return e;if(n.isNumber(e)){if(n.isNaN(e))throw new Error("convert7");if(Math.abs(e)>n.TIMESTAMP_RANGE)throw new Error("toDate1");return new Date(e)}if(n.isNull(e))return null;if(n.isString(e)){if(e.match(n.ISO8601_PATTERN)){const t={date:null,time:null,zone:null},r=e.match(/^\d\d\d\d-\d\d(-\d\d)?/);t.date=r[1]?r[0]:r[0]+"-01";const n=e.match(/([Tt ])(\d\d:\d\d)(:\d\d(\.\d+)?)?/);t.time=n?n[3]?n[2]+n[3]:n[2]+":00":"00:00:00";const s=e.match(/^\d\d\d\d-\d\d(-\d\d)?(.*)/)[2].match(/([Zz]|[+-]\d\d(:?\d\d)?)$/);s?"z"===s[0][0].toLowerCase()?t.zone="Z":t.zone=s[2]?s[1]:s[1]+":00":t.zone="Z";const i=new Date(`${t.date}T${t.time}${t.zone}`);if(Number.isNaN(i.getDay()))throw new Error("toDate1");const a=e.match(/^\d\d\d\d-\d\d-\d\d/);if(a){const e=a[0].split("-"),t=1*e[0],r=1*e[1]-1,n=1*e[2],s=new Date(Date.UTC(t,r,n));if(s.getUTCFullYear()!==t||s.getUTCMonth()!==r||s.getUTCDate()!==n)throw new Error("toDate1")}return i}throw new Error("toDate1")}throw new Error("convert1 :: "+n.getType(e)+",date")}}class n{static isNull(e){return null===e}static isNumber(e){return"number"==typeof e}static isFinite(e){return Number.isFinite(e)}static hasFractionalPart(e){return Math.trunc(e)!==e}static isInfinite(e){return!Number.isFinite(e)&&!Number.isNaN(e)}static isNaN(e){return Number.isNaN(e)}static isDate(e){return e instanceof Date}static is32BitInteger(e){return!!this.isNumber(e)&&(Math.round(e)===e&&!(e<-this.INT32_RANGE||e>this.INT32_RANGE))}static isBoolean(e){return!0===e||!1===e}static isString(e){return"string"==typeof e}static isArray(e){return e instanceof Array}static isObject(e){return!this.isArray(e)&&(!this.isDate(e)&&("object"==typeof e&&null!==e))}static isZero(e){return 0===e}static getType(e){return this.isNumber(e)?this.TYPE_NUMBER:this.isBoolean(e)?this.TYPE_BOOLEAN:this.isString(e)?this.TYPE_STRING:this.isNull(e)?this.TYPE_NULL:this.isArray(e)?this.TYPE_ARRAY:this.isDate(e)?this.TYPE_DATE:this.isObject(e)?this.TYPE_OBJECT:void 0}static fixNegativeZero(e){return e+0}}n.TYPE_DATE="date",n.TYPE_ARRAY="array",n.TYPE_OBJECT="object",n.TYPE_NUMBER="number",n.TYPE_STRING="string",n.TYPE_BOOLEAN="boolean",n.TYPE_NULL="null",n.ISO8601_PATTERN=new RegExp(["^","\\d\\d\\d\\d","-(0\\d|1[0-2])","(","-([0-2]\\d|3[01])",")?","(","[Tt ]","([01][0-9]|2[0-3])",":[0-5]\\d","(",":[0-5]\\d","(","\\.\\d+",")?",")?",")?","(","[Zz]","|"," ?","[+-]","([01][0-9]|2[0-3])","(",":?[0-5]\\d",")?",")?","$"].join("")),n.TIMESTAMP_RANGE=864e13,n.INT32_RANGE=2147483647,n.DOUBLE_RANGE=17976931348623157e292,n.MONGO_LONG_MIN=-0x8000000000000000,n.MONGO_LONG_MAX=0x7ffffffffffffc00;var s={parseError:{ru:"Ошибка синтаксиса в формуле",en:"Syntax error in formula"},evaluateError:{ru:"Ошибка выполнения формулы",en:"Formula execution error"},validateError:{ru:"Ошибка чтения формулы",en:"Formula reading error"},finalizeError:{ru:"Ошибка выполнения формулы",en:"Formula execution error"},convertError:{ru:"Ошибка формирования запроса",en:"Query preparation error"},preevalError:{ru:"Ошибка формирования запроса",en:"Query preparation error"},pathTypeError:{ru:"Неверный путь",en:"Invalid path"},parse1:{ru:"Комментарий не закрыт, не хватает */",en:"Comment not closed, missing */"},parse2:{ru:'Неожиданный символ "$1"',en:'Unexpected character "$1"'},parse3:{ru:"Ожидается выражение после $1",en:"Expression expected after $1"},parse4:{ru:"Отсутствует аргумент оператора",en:"Missing operator argument"},parse5:{ru:'Ожидается символ "$1"',en:'Expected character "$1"'},parse6:{ru:"Название переменной не может начинаться с цифры ($1)",en:"Variable names must not start with a number ($1)"},parse7:{ru:"Число слишком большое",en:"Too large number"},parse8:{ru:"Незакрытая скобка $1",en:"Missing bracket $1"},parse9:{ru:'Отсутствует символ "$1"',en:'Missing character "$1"'},parse10:{ru:"Неверный тип ключа",en:"Wrong key type"},parse11:{ru:"Ожидается свойство объекта",en:"Object property expected"},parse12:{ru:"Неверный ключ объекта",en:"Wrong object key"},parse13:{ru:"Неожиданный вызов функции",en:"Unexpected function call"},parse14:{ru:"Вызов неизвестной функции: $1",en:"Unknown function call: $1"},parse15:{ru:"Ожидается экспонента ($1)",en:"Expected exponent ($1)"},parse16:{ru:'Незакрытая кавычка после "$1"',en:'Missing quote after "$1"'},parse17:{ru:"Неверный формат даты",en:"Wrong date format"},parse18:{ru:"Ожидается оператор присваивания",en:"Assignment operator expected"},parse19:{ru:"Ожидается идентификатор",en:"Identifier expected"},var1:{ru:'Переменной "$1" не существует',en:'Variable "$1" does not exist'},add1:{ru:"Складывать можно только числа и даты (не $1)",en:"Only numbers and dates can be added (не $1)"},subtract1:{ru:"Невозможно вычесть $1 из $2",en:"Unable to subtract $1 from $2"},mod1:{ru:"Делить (%) на ноль нельзя",en:"(%) cannot be divided by zero"},mod2:{ru:"Невозможно поделить (%) $1 на $2",en:"Unable to divide (%) $1 by $2"},divide1:{ru:"Делить на ноль нельзя",en:"Divide by zero is not allowed"},divide2:{ru:"Невозможно поделить $1 на $2",en:"Unable to divide $1 by $2"},member1:{ru:"Невозможно прочитать свойство типа $2 из $1",en:"Unable to read property of type $2 from $1"},member2:{ru:"Отсутствует свойство объекта или элемент массива ($1)",en:"Missing object property or array element ($1)"},member3:{ru:"Номер элемента массива должен быть целым 32-битным числом",en:"The array element number must be a 32-bit integer"},fn1:{ru:"Функция $1 работает только с массивами (передано $2)",en:"The $1 function works with arrays only ($1 passed)"},arg_1st:{ru:"Первый аргумент",en:"First argument"},arg_2nd:{ru:"Второй аргумент",en:"Second argument"},arg_3rd:{ru:"Третий аргумент",en:"Third argument"},fn2:{ru:"$arg функции $1 должен быть числом (передано $2)",en:"$arg of the $1 function must be a number ($2 passed)"},fn3:{ru:"$arg функции $1 должен быть целым 32-битным числом",en:"$arg of the $1 function must be a 32-bit integer"},fn4:{ru:"$arg функции $1 должен быть строкой",en:"$arg of the $1 function must be a string"},fn5:{ru:"$arg функции $1 должен быть строкой (передано $2)",en:"$arg of the $1 function must be a string ($2 passed)"},fn6:{ru:"Функция $1 работает только со строками (передано $2)",en:"The $1 function works with strings only ($2 passed)"},fn7:{ru:"Функция $1 работает только с числами (передано $2)",en:"The $1 function works with numbers only ($2 passed)"},slice2:{ru:"Третий аргумент ($1) функции slice должен быть положительным числом",en:"The third argument ($1) of the slice function must be a positive number"},slice3:{ru:"Второй аргумент ($1) функции slice должен быть числом",en:"The second argument ($1) of the slice function must be a number"},substr3:{ru:"Второй аргумент функции substr не должен быть отрицательным числом",en:"The second argument of the substr function must not be a negative number"},substr5:{ru:"Третий аргумент функции substr не должен быть отрицательным числом",en:"The third argument of the substr function must not be a negative number"},regexTest3:{ru:"Третий аргумент функции regexTest не может быть выражением",en:"The third argument of the regexTest function cannot be an expression"},regexTest4:{ru:"Третий аргумент функции regexTest содержит неизвестные опции",en:"The third argument of the regexTest function consists of unknown options"},regexMatch3:{ru:"Третий аргумент функции regexMatch не может быть выражением",en:"The third argument of the regexMatch function cannot be an expression"},regexMatch4:{ru:"Третий аргумент функции regexMatch содержит неизвестные опции",en:"The third argument of the regexMatch function consists of unknown options"},regexMatchAll3:{ru:"Третий аргумент функции regexMatchAll не может быть выражением",en:"The third argument of the regexMatchAll function cannot be an expression"},regexMatchAll4:{ru:"Третий аргумент функции regexMatchAll содержит неизвестные опции",en:"The third argument of the regexMatchAll function consists of unknown options"},range7:{ru:"Третий аргумент функции range не может быть 0",en:"The third argument of the range function cannot be 0"},pow3:{ru:"Слишком большое число в результате выполнения функции pow",en:"Too large number as a result of the pow function"},pow4:{ru:"Ошибка выполнения функции pow",en:"Pow function error"},log3:{ru:"Первый аргумент функции log должен быть положительным числом",en:"The first argument of the log function must be a positive number"},log4:{ru:"Второй аргумент функции log должен быть положительным числом не равным 1",en:"The second argument of the log function must be a positive number not equal to 1"},split3:{ru:"Второй аргумент функции split не может быть пустой строкой",en:"The second argument of the split function must not be an empty string"},convert1:{ru:"Невозможно преобразовать $1 в $2",en:"Unable to convert $1 to $2"},convert2:{ru:"Дата, преобразуемая в строку должна быть в пределах 10 тысяч лет",en:"The date converted to a string must be within 10,000 years"},convert3:{ru:"Невозможно преобразовать $1 в $2",en:"Unable to convert $1 to $2"},convert4:{ru:"Невозможно преобразовать пустую строку в число",en:"Unable to convert the empty string to a number"},convert5:{ru:"Невозможно преобразовать строку в число: неверный формат",en:"Unable to convert the string to a number: invalid format"},convert6:{ru:"Невозможно преобразовать строку в число: число слишком велико",en:"Unable to convert the string to a number: the number is too large"},convert7:{ru:"Невозможно преобразовать NaN в число",en:"Cannot convert NaN to integer"},round2:{ru:"Второй аргумент функции round должен быть в диапазоне от -20 до 100",en:"The second argument of the round function must be from -20 to 100"},round3:{ru:"Второй аргумент функции round должен быть целым числом",en:"The second argument of the round function must be an integer"},trunc2:{ru:"Второй аргумент функции trunc должен быть в диапазоне от -20 до 100",en:"The second argument of the trunc function must be from -20 to 100"},sqrt2:{ru:"Функция sqrt не работает с отрицательными числами",en:"The sqrt function does not work with negative numbers"},sin2:{ru:"Функция sin работает только с конечными числами",en:"The sin function works with finite numbers only"},cos2:{ru:"Функция cos работает только с конечными числами",en:"The cos function works with finite numbers only"},atanh2:{ru:"Функция atanh работает только с числами в диапазоне от -1 до 1",en:"The atanh function works with numbers between -1 and 1 only"},acos2:{ru:"Функция acos работает только с числами в диапазоне от -1 до 1",en:"The acos function works with numbers between -1 and 1 only"},acosh2:{ru:"Функция acosh работает только с числами в диапазоне от 1",en:"The acosh function works with numbers in the range from 1"},asin2:{ru:"Функция asin работает только с числами в диапазоне от -1 до 1",en:"The asin function works with numbers between -1 and 1 only"},tan2:{ru:"Функция tan работает только с конечными числами",en:"The tan function works with finite numbers only"},in1:{ru:"Оператор in работает только с массивами (передано $1)",en:"The in operator works with arrays only ($1 passed)"},general1:{ru:"Слишком большое число",en:"Too large number"},toDate1:{ru:"Ошибка преобразования значения в дату",en:"Error converting the value to date"},let1:{ru:"Первый аргумент функции let должен быть статичным объектом",en:"The first argument of the let function must be a static object"},let2:{ru:"Названия переменных в функции let должны содержать только латинские буквы и цифры",en:"Variable names in the let function must consist of Latin letters and numbers only "},indexOf1:{ru:"Первый аргумент функции indexOf должен быть массивом (передано $1)",en:"The first argument of the indexOf function must be an array ($1 passed)"},arrayToObject1:{ru:"Функция arrayToObject работает только с массивами (передано $1)",en:"The arrayToObject function works with arrays only ($1 passed)"},arrayToObject2:{ru:"Функция arrayToObject ожидает массив из пар ключ-значение (передано $1)",en:""},arrayToObject3:{ru:"Функция arrayToObject ожидает массив из пар ключ-значение, где ключ является строкой (передано $1)",en:""},arrayToObject4:{ru:"Функция arrayToObject ожидает массив из пар ключ-значение размером в 2 элемента (передано $1)",en:""},arrayToObject5:{ru:"Функция arrayToObject ожидает, что все элементы будут или массивами или объектами (передано $1, потом $2)",en:""},arrayToObject6:{ru:'Функция arrayToObject ожидает, что все элементы будут объектами с полями "k" и "v", где "k" это строка (передано $1)',en:""},arrayToObject7:{ru:'Функция arrayToObject ожидает массив объектов с двумя полями "k" и "v" (передано $1)',en:""},arrayToObject8:{ru:'Функция arrayToObject ожидает массив объектов с двумя полями "k" и "v", отсутствует одно из них, или оба',en:""},objectToArray1:{ru:"Функция objectToArray работает только с объектами (передано $1)",en:"The objectToArray function works with objects only ($1 passed)"},dateAdd1:{ru:"Аргумент 'unit' функции dateAdd должен быть строкой (передано $1)",en:"The ‘unit’ argument of the dateAdd function must be a string ($1 passed)"},dateAdd2:{ru:"Аргумент 'date' функции dateAdd должен быть датой",en:"The ‘date’ argument of the dateAdd function must be a date"},dateAdd3:{ru:"Аргумент 'unit' функции dateAdd не правильный",en:""},dateAdd4:{ru:"Аргумент 'amount' функции dateAdd должен быть целым числом",en:"The ‘amount’ argument of the date Add function must be an integer"},dateAdd5:{ru:"Аргумент 'amount' функции dateAdd не правильный",en:""},dateSubtract1:{ru:"Аргумент 'unit' функции dateSubtract должен быть строкой (передано $1)",en:"The ‘unit’ argument of the dateSubstract function must be a string ($1 passed)"},dateSubtract2:{ru:"Аргумент 'date' функции dateSubtract должен быть датой",en:"The ‘date’ argument of the dateSubstract function must be a date"},dateSubtract3:{ru:"Аргумент 'unit' функции dateSubtract не правильный",en:""},dateSubtract4:{ru:"Аргумент 'amount' функции dateSubtract должен быть целым числом",en:"The ‘amount’ argument of the dateSubstract function must be an integer"},dateSubtract5:{ru:"Аргумент 'amount' функции dateSubtract не правильный",en:""},exists1:{ru:"Неверный аргумент функции exists",en:""},unique1:{ru:"Первый аргумент функции unique должен быть массивом (передано $1)",en:"The first argument of the unique function must be an array ($1 passed)"},editor:{goto_playground:{ru:"Открыть в песочнице",en:"Open in playground"},playground_href:{ru:"https://cremax.ru/formula-playground",en:"https://crebase.com/formula-playground"}},scope_viewer:{copy_path:{ru:"Скопировать путь: %path%",en:"Copy path: %path%"},copied:{ru:"Скопировано: %path%",en:"Copied: %path%"}},toTable1:{ru:"Ожидался массив, передано $1",en:"Array expected, $1 passed"},toTable2:{ru:"Ожидался массив объектов, найден элемент $1",en:""}};class i{static perform(e){if(n.isNull(e))return{columns:[],rows:[],total_count:0};if(n.isArray(e)){if(0===e.length)return{columns:[],rows:[],total_count:0};{let t=null;const r=e.map((e=>{if(!n.isObject(e))throw new Error("toTable2 :: "+n.getType(e));null===t&&(t=Object.keys(e));let r={};return t.forEach((t=>{var n;r[t]=null!==(n=e[t])&&void 0!==n?n:null})),r}));return{columns:t.map((e=>({id:e,name:e,type:"any"}))),rows:r,total_count:e.length}}}throw new Error("toTable1 :: "+n.getType(e))}}class a{constructor(e){this.Expr=e}}class o extends a{constructor(e,t){if(super(e),this.existsMode=!1,!t||!t.hasOwnProperty("name"))throw new Error("String without name");if(!n.isString(t.name))throw new Error("Name is not string");t.hasOwnProperty("column")?this.column=!!t.column:this.column=!1,this.name=t.name}enableExistsMode(){this.existsMode=!0}optimize(){return this}_evaluate(e){if(this.Expr.checkEvaluationLimits(this),this.column)throw new Error("Column execution is not supported here");return e.hasOwnProperty(this.name)}evaluate(e){if(this._evaluate(e))return e[this.name];if(this.existsMode)return null;throw new Error("var1 :: "+this.name)}evaluateExists(e){return this._evaluate(e)}gatherExternalIdentifiers(){return this.column?["@"+this.name]:[this.name]}preEvaluate(e,t){return this.column||e.includes(this.name)?this:new u(this,t)}toCode(){return this.column?"@"+this.name:this.name}}class u extends a{constructor(e,t=null){super(e.Expr),this.source=e,this.result=e.evaluate(t||{})}optimize(){return this}evaluate(e){return this.Expr.checkEvaluationLimits(this),this.result}gatherExternalIdentifiers(){return[]}preEvaluate(e,t){return this}toCode(){return z.prettyPrint(this.result,!1)}}class l extends a{constructor(e,t){if(super(e),this.arguments=[],t.length>this.maxArguments())throw new Error("Too much arguments");if(t.length<this.minArguments())throw new Error("Not enough arguments");for(const e of t)this.arguments.push(this.Expr.makeNode(e))}minArguments(){return 0}maxArguments(){return 0}optimize(){let e=!0;for(let t=0;t<this.arguments.length;t++)this.arguments[t]=this.arguments[t].optimize(),this.arguments[t]instanceof u||(e=!1);return e?new u(this):this}evaluate(e){}localVariableList(){return[]}gatherExternalIdentifiers(){let e=[];return this.arguments.forEach((t=>{e=[...e,...t.gatherExternalIdentifiers()]})),e=e.filter((e=>!this.localVariableList().includes(e))),e}preEvaluate(e,t){const r=[...e,...this.localVariableList()];let n=!0;return this.arguments.forEach(((e,s)=>{this.arguments[s]=e.preEvaluate(r,t),this.arguments[s]instanceof u||(n=!1)})),n||0===Object.keys(this.gatherExternalIdentifiers()).length?new u(this,t):this}toCode(){const e=Object.keys(z.FUNCTIONS).find((e=>z.FUNCTIONS[e]===this.constructor));if(e)return[e,"(",this.arguments.map((e=>e.toCode())).join(", "),")"].join("");const t=Object.keys(z.BINARY_OPERATORS).find((e=>z.BINARY_OPERATORS[e]===this.constructor));if(t)return["(",this.arguments[0].toCode()," "+t+" ",this.arguments[1].toCode(),")"].join("");throw new Error("Unknown function")}}class h extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e),s=this.arguments[1].evaluate(e);if(n.isArray(s)){let e=!1;for(const n of s)if(t.isEqual(n,r)){e=!0;break}return e}throw new Error("in1 :: "+n.getType(s))}}h.binaryOperatorPrecedence=7;class c extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e),n=this.arguments[1].evaluate(e);return t.isEqual(r,n)}}c.binaryOperatorPrecedence=6;class m extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e),n=this.arguments[1].evaluate(e);return!t.isEqual(r,n)}}m.binaryOperatorPrecedence=6;class p extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e),n=this.arguments[1].evaluate(e);return t.isGreater(r,n)}}p.binaryOperatorPrecedence=7;class f extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e),n=this.arguments[1].evaluate(e);return t.isGreater(r,n)||t.isEqual(r,n)}}f.binaryOperatorPrecedence=7;class g extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e),n=this.arguments[1].evaluate(e);return t.isLess(r,n)}}g.binaryOperatorPrecedence=7;class d extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e),n=this.arguments[1].evaluate(e);return t.isLess(r,n)||t.isEqual(r,n)}}d.binaryOperatorPrecedence=7;class E extends l{constructor(e,t){super(e,t.map((e=>({type:"CallExpression",arguments:[e],callee:"toBoolean",location:[0,0]}))))}minArguments(){return 2}maxArguments(){return 10}optimize(){let e=0;for(const t of this.arguments)this.arguments[e++]=t.optimize();for(const e of this.arguments)if(e instanceof u&&!e.result)return this.arguments=[e],new u(this);return this}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=[];for(const r of this.arguments)if(r instanceof u){if(!r.evaluate(e))return!1}else t.push(r);for(const r of t)if(!r.evaluate(e))return!1;return!0}}E.binaryOperatorPrecedence=2;class v extends l{constructor(e,t){super(e,t.map((e=>({type:"CallExpression",arguments:[e],callee:"toBoolean",location:[0,0]}))))}minArguments(){return 2}maxArguments(){return 10}optimize(){let e=0;for(const t of this.arguments)this.arguments[e++]=t.optimize();for(const e of this.arguments)if(e instanceof u&&e.result)return this.arguments=[e],new u(this);return this}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=[];for(const r of this.arguments)if(r instanceof u){if(r.evaluate(e))return!0}else t.push(r);for(const r of t)if(r.evaluate(e))return!0;return!1}}v.binaryOperatorPrecedence=1;class w extends l{minArguments(){return 2}maxArguments(){return 2}assertId(e,t=!1){if(!/^[a-z]+[a-zA-Z0-9_]*$/.test(e)){if(t)return!1;throw new Error("let2 :: "+e)}return!0}optimize(){return this}evaluate(e){if(this.Expr.checkEvaluationLimits(this),!(this.arguments[0]instanceof C))throw new Error("let1");for(const t in this.arguments[0].object){if(!w.IDRE.test(t))throw new Error("let2 :: "+t);(e=Object.assign({},e))[t]=this.arguments[0].object[t].evaluate(e)}return this.arguments[1].evaluate(e)}gatherExternalIdentifiers(){let e=[],t=[];for(const[r,n]of Object.entries(this.arguments[0].object))this.assertId(r),t=[...t,...n.gatherExternalIdentifiers().filter((t=>!e.includes(t)))],e.push(r);return t=[...t,...this.arguments[1].gatherExternalIdentifiers().filter((t=>!e.includes(t)))],t}preEvaluate(e,t){const r=[...e];let n=!0;for(const[e,s]of Object.entries(this.arguments[0].object))this.assertId(e),this.arguments[0].object[e]=s.preEvaluate(r,t),this.arguments[0].object[e]instanceof u?(t=Object.assign({},t))[e]=this.arguments[0].object[e].evaluate(t):(n=!1,r.push(e));return this.arguments[1]=this.arguments[1].preEvaluate(r,t),this.arguments[1]instanceof u||(n=!1),n||0===Object.keys(this.gatherExternalIdentifiers()).length?new u(this,t):this}}w.IDRE=/^[a-z]+[a-zA-Z0-9_]*$/;class b extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(t)||n.isNull(r))return null;if(!n.isNumber(t)||!n.isNumber(r))throw new Error("divide2 :: "+n.getType(t)+","+n.getType(r));if(n.isZero(r))throw new Error("divide1");return t/r}}b.binaryOperatorPrecedence=10;class x extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(t)||n.isNull(r))return null;if(!n.isNumber(t)||!n.isNumber(r))throw new Error("mod2 :: "+n.getType(t)+","+n.getType(r));if(n.isZero(r))throw new Error("mod1");return t%r}}x.binaryOperatorPrecedence=10;class y extends l{minArguments(){return 1}maxArguments(){return 1}optimize(){if(this.arguments[0]instanceof D){const e=[];for(const t of this.arguments[0].array)if(t instanceof y)if(t.arguments[0]instanceof D)for(const r of t.arguments[0].array)e.push(r);else e.push(t);else e.push(t);this.arguments[0].array=e;let t=[],r=[];for(const e of this.arguments[0].array){const n=e.optimize();n instanceof u?t.push(n):r.push(n)}if(t.length&&(t.length>1&&(this.arguments[0].array=t,t=[new u(this)]),this.arguments[0].array=[...r,...t]),!r.length)return new u(this)}return this}multiply(e){if(n.isNull(e))return null;if(n.isNumber(e)){if(n.isFinite(e)&&(e>n.MONGO_LONG_MAX||e<n.MONGO_LONG_MIN))throw new Error("general1");return this.result*=e}throw new Error("fn7 :: multiply,"+n.getType(e))}evaluate(e){if(this.Expr.checkEvaluationLimits(this),this.result=1,this.arguments[0]instanceof D){for(const t of this.arguments[0].array)if(null===this.multiply(t.evaluate(e)))return null}else{const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isArray(t))throw new Error("fn7 :: multiply,"+n.getType(t));for(const e of t)if(null===this.multiply(e))return null}return this.result}}y.binaryOperatorPrecedence=10;class T extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),s=this.arguments[1].evaluate(e);if(n.isNull(t)||n.isNull(s))return null;if(n.isDate(t)&&n.isNumber(s))return r.toDate(r.toNumber(t)-s);if(!n.isNumber(t)||!n.isNumber(s))throw new Error("subtract1 :: "+n.getType(s)+","+n.getType(t));return t-s}}T.binaryOperatorPrecedence=9;class N extends l{constructor(){super(...arguments),this.isDate=!1}minArguments(){return 1}maxArguments(){return 1}optimize(){if(this.arguments[0]instanceof D){const e=[];for(const t of this.arguments[0].array)if(t instanceof N)if(t.arguments[0]instanceof D)for(const r of t.arguments[0].array)e.push(r);else e.push(t);else e.push(t);this.arguments[0].array=e;let t=[],r=[];for(const e of this.arguments[0].array){const n=e.optimize();n instanceof u?t.push(n):r.push(n)}if(t.length&&(t.length>1&&(this.arguments[0].array=t,t=[new u(this)]),this.arguments[0].array=[...r,...t]),!r.length)return new u(this)}return this}add(e){if(n.isNull(e))return null;if(n.isNumber(e))return this.result+=e;if(n.isDate(e))return this.isDate=!0,this.result+=r.toNumber(e);throw new Error("add1 :: "+n.getType(e))}evaluate(e){if(this.Expr.checkEvaluationLimits(this),this.result=0,this.arguments[0]instanceof D){for(const t of this.arguments[0].array)if(null===this.add(t.evaluate(e)))return null}else{const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isArray(t))throw new Error("add1 :: "+n.getType(t));for(const e of t)if(null===this.add(e))return null}return this.isDate?r.toDate(this.result):this.result}}N.binaryOperatorPrecedence=9;class A extends l{minArguments(){return 1}maxArguments(){return 2}optimize(){if(this.arguments[0]instanceof D)if(1===this.arguments.length){const e=[];for(const t of this.arguments[0].array)if(t instanceof A)if(1===t.arguments.length&&t.arguments[0]instanceof D)for(const r of t.arguments[0].array)e.push(r);else e.push(t);else e.push(t);this.arguments[0].array=e;let t=0;for(const e of this.arguments[0].array){const n=e.optimize();n instanceof u&&(n.result=r.toString(n.result),this.arguments[0].array[t]=n),t++}}else this.arguments[0]=this.arguments[0].optimize(),this.arguments[1]=this.arguments[1].optimize();return this}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);let s="";if(this.arguments.length>1&&(s=this.arguments[1].evaluate(e)),n.isString(t))return t;if(n.isNull(t))return"";if(n.isArray(t)){if(!n.isString(s))throw new Error("fn5 :: join,2nd,"+n.getType(s));let e="",i=0;for(const a of t)i++>0&&(e+=s),n.isNull(a)||(e+=r.toString(a));return e}throw new Error("fn6 :: join,"+n.getType(t))}}A.binaryOperatorPrecedence=8;class O extends l{minArguments(){return 1}maxArguments(){return 1}trim(e,t){let r=0,n=e.length;for(;r<n&&t.indexOf(e[r])>=0;)++r;for(;n>r&&t.indexOf(e[n-1])>=0;)--n;return r>0||n<e.length?e.substring(r,n):e}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(n.isString(t))return this.trim(t,O.WHITESPACE);throw new Error("fn6 :: trim,"+n.getType(t))}}O.WHITESPACE="\0 \t\n\v\f\r             ";class _ extends l{minArguments(){return 2}maxArguments(){return 3}static validateFlags(e){return null!==e.match(/^[ims]*$/)}optimize(){if(this.arguments[1]=this.arguments[1].optimize(),this.arguments[1]instanceof u&&!n.isNull(this.arguments[1].result)&&!n.isString(this.arguments[1].result))throw new Error("fn4 :: regexTest,2nd");return this}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(t))return!1;if(!n.isString(t))throw new Error("fn4 :: regexTest,1st");if(n.isNull(r))return!1;if(!n.isString(r))throw new Error("fn4 :: regexTest,2nd");let s,i="";if(this.arguments.length>2){if(!(this.arguments[2]instanceof L))throw new Error("regexTest3");if(i=this.arguments[2].evaluate(e),!_.validateFlags(i))throw new Error("regexTest4")}try{s=new RegExp(r,i+"u")}catch(e){throw new Error("regexTest3")}return s.test(t)}}class k extends l{constructor(e,t){super(e,t),this.arguments[0]instanceof P&&this.arguments[0].disableNullSafety()}minArguments(){return 1}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);return this.arguments.length>1?null!=t?t:this.arguments[1].evaluate(e):null!=t?t:null}}k.binaryOperatorPrecedence=11,k.rightAssociative=!0;class S extends a{constructor(e,t){if(super(e),!t||!t.hasOwnProperty("value"))throw new Error("Number without value");if("NaN"!==t.value)if("Infinity"!==t.value){if(!n.isNumber(t.value))throw new Error("Number is not number");this.value=t.value}else this.value=1/0;else this.value=NaN}optimize(){return new u(this)}evaluate(e){return this.Expr.checkEvaluationLimits(this),this.value}gatherExternalIdentifiers(){return[]}preEvaluate(e,t){return new u(this,t)}toCode(){return z.prettyPrint(this.value)}}class L extends a{constructor(e,t){if(super(e),!t||!t.hasOwnProperty("value"))throw new Error("String without value");if(!n.isString(t.value))throw new Error("String is not string");this.value=t.value}optimize(){return new u(this)}evaluate(e){return this.Expr.checkEvaluationLimits(this),this.value}gatherExternalIdentifiers(){return[]}preEvaluate(e,t){return new u(this,t)}toCode(){return z.prettyPrint(this.value)}}class M extends a{constructor(e,t){if(super(e),!t||!t.hasOwnProperty("value"))throw new Error("Date without value");if(!n.isString(t.value))throw new Error("Date is not string");this.value=t.value}optimize(){return new u(this)}evaluate(e){return this.Expr.checkEvaluationLimits(this),new Date(this.value)}gatherExternalIdentifiers(){return[]}preEvaluate(e,t){return new u(this,t)}toCode(){return z.prettyPrint(this.value)}}class j extends a{constructor(e,t){super(e),this.value=null}optimize(){return new u(this)}evaluate(e){return this.Expr.checkEvaluationLimits(this),this.value}gatherExternalIdentifiers(){return[]}preEvaluate(e,t){return new u(this,t)}toCode(){return z.prettyPrint(this.value)}}class $ extends a{constructor(e,t){if(super(e),!t||!t.hasOwnProperty("value"))throw new Error("Boolean without value");if(!n.isBoolean(t.value))throw new Error("Boolean is not boolean");this.value=t.value}optimize(){return new u(this)}evaluate(e){return this.Expr.checkEvaluationLimits(this),this.value}gatherExternalIdentifiers(){return[]}preEvaluate(e,t){return new u(this,t)}toCode(){return z.prettyPrint(this.value)}}class C extends a{constructor(e,t){if(super(e),!t)throw new Error("Wrong node");if(!t.hasOwnProperty("properties"))throw new Error("Object without properties");this.object={};for(const e of t.properties){if(!e.hasOwnProperty("key"))throw new Error("Object property without key");if("string"!=typeof e.key)throw new Error("Object property key is not string");if(!e.hasOwnProperty("value"))throw new Error("Object property without value");this.object[e.key]=this.Expr.makeNode(e.value)}}optimize(){let e=!0;for(const t in this.object)this.object[t]=this.object[t].optimize(),this.object[t]instanceof u||(e=!1);return e?new u(this):this}evaluate(e){this.Expr.checkEvaluationLimits(this);const t={};for(const r in this.object)t[r]=this.object[r].evaluate(e);return t}gatherExternalIdentifiers(){let e=[];for(const t in this.object)e=[...e,...this.object[t].gatherExternalIdentifiers()];return e}preEvaluate(e,t){let r=!0;for(const[n,s]of Object.entries(this.object))this.object[n]=s.preEvaluate(e,t),this.object[n]instanceof u||(r=!1);return r?new u(this,t):this}toCode(){return["{",Object.keys(this.object).map((e=>z.prettyPrint(e)+": "+this.object[e].toCode())).join(", "),"}"].join("")}}class D extends a{constructor(e,t){if(super(e),!t)throw new Error("Wrong node");if(!t.hasOwnProperty("elements"))throw new Error("Array without elements");this.array=[];for(const e of t.elements)this.array.push(this.Expr.makeNode(e))}optimize(){let e=!0;for(let t=0;t<this.array.length;t++)this.array[t]=this.array[t].optimize(),this.array[t]instanceof u||(e=!1);return e?new u(this):this}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=[];for(const r of this.array)t.push(r.evaluate(e));return t}gatherExternalIdentifiers(){let e=[];return this.array.forEach((t=>{e=[...e,...t.gatherExternalIdentifiers()]})),e}preEvaluate(e,t){let r=!0;for(const[n,s]of Object.entries(this.array))this.array[n]=s.preEvaluate(e,t),this.array[n]instanceof u||(r=!1);return r?new u(this,t):this}toCode(){return["[",this.array.map((e=>e.toCode())).join(", "),"]"].join("")}}class P extends a{constructor(e,t){if(super(e),this.nullSafe=!0,this.existsMode=!1,!t)throw new Error("Wrong node");if(!t.hasOwnProperty("object"))throw new Error("Member expression without object");if(!t.hasOwnProperty("property"))throw new Error("Member expression without property");this.object=this.Expr.makeNode(t.object),this.property=this.Expr.makeNode(t.property)}disableNullSafety(){this.nullSafe=!1,this.object instanceof P&&this.object.disableNullSafety()}enableExistsMode(){this.existsMode=!0,(this.object instanceof P||this.object instanceof o)&&this.object.enableExistsMode()}optimize(){return this.object=this.object.optimize(),this.property=this.property.optimize(),this}evaluate(e,t=!1){this.Expr.checkEvaluationLimits(this);const r=this.object.evaluate(e);let s=this.property.evaluate(e);if(n.isNull(r)&&!1===this.nullSafe)return null;if(n.isArray(r)&&n.isNumber(s)){if(n.is32BitInteger(s)){const e=s<0?r.length+s:s;if(r.hasOwnProperty(e))return r[e];if(r[e],this.nullSafe)throw this.existsMode?new Error("undefined"):new Error("member2 :: "+s);return null}throw new Error("member3")}if(n.isObject(r)&&n.isString(s)){if(r.hasOwnProperty(s))return r[s];if(r[s],this.nullSafe)throw this.existsMode?new Error("undefined"):new Error("member2 :: "+s);return null}throw this.existsMode?new Error("undefined"):new Error("member1 :: "+n.getType(r)+","+n.getType(s))}evaluateExists(e){try{return this.evaluate(e),!0}catch(e){if("undefined"===e.message)return!1;throw e}}gatherExternalIdentifiers(){return[...this.object.gatherExternalIdentifiers(),...this.property.gatherExternalIdentifiers()]}preEvaluate(e,t){return this.object=this.object.preEvaluate(e,t),this.property=this.property.preEvaluate(e,t),this.object instanceof u&&this.property instanceof u?new u(this,t):this}toCode(){return[this.object.toCode(),"[",this.property.toCode(),"]"].join("")}}class I extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);return n.isNull(t)?null:(I.validateValueIsArray(t),n.isNull(r)?t:(I.validateValueIsArray(r),Object.keys(t).filter((e=>r.includes(e))).reduce(((e,r)=>(e[r]=t[r],e)),{})))}static validateValueIsArray(e){if(!n.isArray(e))throw new Error("fn1 :: pickKeys,"+n.getType(e))}}class z{constructor(e,t){if(this.limitMode=0,this.evaluationCounter=0,void 0===t)throw new Error("limitNode is required");this.ast=e,this.limitMode=t}isEmpty(){return null===this.ast.error&&null===this.ast.source}makeNode(e){if(!e||!e.hasOwnProperty("type"))throw new Error("Node without type");if("CallExpression"===e.type){if(!e.hasOwnProperty("arguments"))throw new Error("Call expression without arguments");if(!e.hasOwnProperty("callee"))throw new Error("Call expression without callee");if(!z.FUNCTIONS[e.callee])throw new Error("Unknown function call");return new z.FUNCTIONS[e.callee](this,e.arguments)}if("UnaryExpression"===e.type){if(!e.hasOwnProperty("argument"))throw new Error("Unary operator without argument");if(!e.hasOwnProperty("operator"))throw new Error("Unary operator without operator");if("+"===e.operator)return new N(this,[{type:"ArrayExpression",elements:[{type:"Number",value:0,location:[0,0]},e.argument],location:[0,0]}]);if("-"===e.operator)return new T(this,[{type:"Number",value:0,location:[0,0]},e.argument]);if("?"===e.operator)return new k(this,[e.argument,{type:"Null",location:[0,0]}]);throw new Error("Unknown unary operator")}if("BinaryExpression"===e.type){if(!e.hasOwnProperty("left"))throw new Error("Binary operator without left");if(!e.hasOwnProperty("right"))throw new Error("Binary operator without right");if(!z.BINARY_OPERATORS[e.operator])throw new Error("Unknown binary operator");let t;return t=["&","+","*"].includes(e.operator)?[{type:"ArrayExpression",elements:[e.left,e.right],location:[0,0]}]:[e.left,e.right],new z.BINARY_OPERATORS[e.operator](this,t)}if(!z.NODES[e.type])throw new Error("Unknown node type");return new z.NODES[e.type](this,e)}resetEvaluationLimits(){this.evaluationCounter=0}checkEvaluationLimits(e){if(this.limitMode&&e instanceof l){if(this.evaluationCounter++,this.limitMode===z.LIMIT_MODE_10K&&this.evaluationCounter>1e4)throw new Error("Limit 10k exceeded");if(this.limitMode===z.LIMIT_MODE_1M&&this.evaluationCounter>1e6)throw new Error("Limit 1 million exceeded")}}evaluate(e){this.resetEvaluationLimits();const t=Date.now();if(this.isEmpty())return{error:null,result:null,time:Date.now()-t};if(null!==this.ast.error)return{error:"parse :: "+this.ast.error.message,result:null,time:Date.now()-t};try{const r=this.makeNode(this.ast.source);try{const n=r.optimize();try{return{error:null,result:n.evaluate(e),time:Date.now()-t}}catch(e){return{error:"evaluate :: "+e.message,result:null,time:Date.now()-t}}}catch(e){return{error:"optimize :: "+e.message,result:null,time:Date.now()-t}}}catch(e){return{error:"validate :: "+e.message,result:null,time:Date.now()-t}}}evaluateToBoolean(e){const t=this.evaluate(e);if(t.error)return t;try{return{error:null,result:r.toBoolean(t.result)}}catch(e){return{error:"finalize :: "+e.message,result:null}}}evaluateToString(e){const t=this.evaluate(e);if(t.error)return t;try{return{error:null,result:r.toString(t.result)}}catch(e){return{error:"finalize :: "+e.message,result:null}}}evaluateToNumber(e){const t=this.evaluate(e);if(t.error)return t;try{return{error:null,result:r.toNumber(t.result)}}catch(e){return{error:"finalize :: "+e.message,result:null}}}evaluateToTable(e){const t=this.evaluate(e);if(t.error)return t;try{return{error:null,result:i.perform(t.result)}}catch(e){return{error:"finalize :: "+e.message,result:null}}}static prettyPrint(e,t=""){const s=!1===t,i=!s&&t+"  ";if(n.isObject(e)){if(0===Object.keys(e).length)return"{}";{const r=[];for(const t in e)r.push([s?"":i,JSON.stringify(t),": ",z.prettyPrint(e[t],i)].join(""));return[s?"{":"{\n",r.join(s?", ":",\n"),s?"}":"\n"+t+"}"].join("")}}if(n.isArray(e)){if(0===e.length)return"[]";{const r=[];for(const t of e)r.push([s?"":i,z.prettyPrint(t,i)].join(""));return[s?"[":"[\n",r.join(s?", ":",\n"),s?"]":"\n"+t+"]"].join("")}}if(n.isDate(e))return"#"+r.toString(e)+"#";if(n.isString(e))return JSON.stringify(r.toString(e));if(n.isNumber(e))return r.toString(e);if(n.isNull(e))return"null";if(n.isBoolean(e))return r.toString(e);throw new Error("Unknown type")}static encodeTypes(e){if(n.isDate(e))return{__formula_encoded_type__:"date",date:r.toString(e)};if(n.isArray(e)){const t=[...e];let r=0;for(const e of t)t[r++]=this.encodeTypes(e);return t}if(n.isObject(e)){const t=Object.assign({},e);for(const e in t)t[e]=this.encodeTypes(t[e]);return t}return Number.isNaN(e)?{__formula_encoded_type__:"NaN"}:e===1/0?{__formula_encoded_type__:"Infinity"}:e===-1/0?{__formula_encoded_type__:"-Infinity"}:e}static encodeDataToJSON(e,t=!1){return JSON.stringify(this.encodeTypes(e),null,t?2:null)}static decodeTypes(e){if(void 0!==(null==e?void 0:e.__formula_encoded_type__))return"date"===e.__formula_encoded_type__?r.toDate(e.date||e.timestamp):"NaN"===e.__formula_encoded_type__?NaN:"Infinity"===e.__formula_encoded_type__?1/0:"-Infinity"===e.__formula_encoded_type__?-1/0:e;if(n.isArray(e)){const t=[...e];let r=0;for(const e of t)t[r++]=this.decodeTypes(e);return t}if(n.isObject(e)){const t=Object.assign({},e);for(const e in t)t[e]=this.decodeTypes(t[e]);return t}return e}static decodeDataFromJSON(e){return this.decodeTypes(JSON.parse(e))}static deepClone(e){return this.decodeDataFromJSON(this.encodeDataToJSON(e))}preEvaluate(e){const t=Date.now();if(this.isEmpty())return{error:null,result:null,time:Date.now()-t};if(null!==this.ast.error)return{error:"parse :: "+this.ast.error.message,result:null,time:Date.now()-t};try{let t=this.makeNode(this.ast.source);try{t=t.preEvaluate([],e)}catch(e){return{error:"preeval :: "+e.message,result:null}}try{return{error:null,result:t.toCode()}}catch(e){return{error:"convert :: "+e.message,result:null}}}catch(e){return{error:"validate :: "+e.message,result:null,time:Date.now()-t}}}}z.ErrorTranslator=class{static hasTranslationFor(e){const t=e.split(" :: ");return void 0!==s[t[1]]}static translateTo(e,t){try{const r=e.split(" :: "),n=r[0];if("optimize"===n||"evaluate"===n){const n=r[1],i=r.length>2?r[2].split(","):[];if(s.hasOwnProperty(n)){let e=s[n][t],r=1;for(const t of i)e=e.replace("$"+r++,t);return`${s.evaluateError.ru}: ${e}`}return`${s.evaluateError.ru}: ${e}`}if(["parse","validate","finalize","convert","preeval"].includes(n)){const e=r[1],i=r[2];let a=s[e][t].replace("$1",i);return`${s[n+"Error"].ru}: ${a}`}return e}catch(t){return e}}static toRussian(e){return this.translateTo(e,"ru")}},z.Typing=n,z.Comparison=t,z.NODES={Number:S,String:L,Date:M,Boolean:$,Null:j,Identifier:o,ObjectExpression:C,ArrayExpression:D,MemberExpression:P},z.FUNCTIONS={pickKeys:I,if:class extends l{minArguments(){return 3}maxArguments(){return 101}constructor(e,t){if((t.length-1)%2>0)throw new Error("Wrong argument count");t=[...t];for(let e=0;e<t.length-1;e+=2)t[e]={type:"CallExpression",arguments:[t[e]],callee:"toBoolean",location:[0,0]};super(e,t)}evaluate(e){this.Expr.checkEvaluationLimits(this);for(let t=0;t<this.arguments.length-1;t+=2)if(this.arguments[t].evaluate(e))return this.arguments[t+1].evaluate(e);return this.arguments[this.arguments.length-1].evaluate(e)}},mod:x,multiply:y,sum:N,round:class extends l{minArguments(){return 1}maxArguments(){return 2}roundHalfToEven(e){return.5===Math.abs(e%1)?2*Math.round(e/2):Math.round(e)}roundHalfTowardZero(e){return.5===Math.abs(e%1)?Math.round(e-.5*Math.sign(e)):Math.round(e)}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);let r=0;if(this.arguments.length>1&&(r=this.arguments[1].evaluate(e)),n.isNull(t)||n.isNull(r))return null;if(!n.isNumber(t))throw new Error("fn7 :: round,"+n.getType(t));if(!n.isNumber(r))throw new Error("convert3 :: "+n.getType(r)+",number");if(!n.isFinite(r))throw new Error("general1");if(n.hasFractionalPart(r))throw new Error("round3");if(r<-20||r>100)throw new Error("round2 :: "+r);const s=Math.pow(10,Math.abs(r)),i=r<0?1/s:s;return r>0?n.fixNegativeZero(this.roundHalfTowardZero(t*i)/i):n.fixNegativeZero(this.roundHalfToEven(t*i)/i)}},floor:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: floor,"+n.getType(t));return Math.floor(t)}},ceil:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: ceil,"+n.getType(t));return Math.ceil(t)}},abs:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: abs,"+n.getType(t));return Math.abs(t)}},random:class extends l{minArguments(){return 0}maxArguments(){return 0}optimize(){return this}evaluate(e){return this.Expr.checkEvaluationLimits(this),Math.random()}},min:class extends l{minArguments(){return 1}maxArguments(){return 1}optimize(){return this.arguments[0]instanceof D?super.optimize():this}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e);if(n.isNull(r))return null;if(!n.isArray(r))throw new Error("fn1 :: min,"+n.getType(r));if(0===r.length)return null;let s=null;for(const e of r)n.isNull(e)||(null===s||t.isLess(e,s))&&(s=e);return s}},max:class extends l{minArguments(){return 1}maxArguments(){return 1}optimize(){return this.arguments[0]instanceof D?super.optimize():this}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e);if(n.isNull(r))return null;if(!n.isArray(r))throw new Error("fn1 :: max,"+n.getType(r));if(0===r.length)return null;let s=null;for(const e of r)n.isNull(e)||(null===s||t.isGreater(e,s))&&(s=e);return s}},pow:class extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(t)||n.isNull(r))return null;if(!n.isNumber(t))throw new Error("fn2 :: pow,1st,"+n.getType(t));if(!n.isNumber(r))throw new Error("fn2 :: pow,2nd,"+n.getType(r));const s=Math.pow(t,r);if(s>n.DOUBLE_RANGE)throw new Error("pow3");if(n.isNaN(s))throw new Error("pow4");return s}},sqrt:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: sqrt,"+n.getType(t));if(t<0)throw new Error("sqrt2");return Math.sqrt(t)}},log:class extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(t)||n.isNull(r))return null;if(!n.isNumber(t))throw new Error("fn2 :: log,1st,"+n.getType(t));if(t<=0)throw new Error("log3");if(!n.isNumber(r))throw new Error("fn2 :: log,2nd,"+n.getType(r));if(r<=0||1===r)throw new Error("log4");return Math.log(t)/Math.log(r)}},exp:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: exp,"+n.getType(t));return Math.exp(t)}},trunc:class extends l{minArguments(){return 1}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);let r=0;if(this.arguments.length>1&&(r=this.arguments[1].evaluate(e)),n.isNull(t)||n.isNull(r))return null;if(!n.isNumber(t))throw new Error("fn7 :: trunc,"+n.getType(t));if(!n.isNumber(r))throw new Error("convert3 :: "+n.getType(r)+",number");if(r<-20||r>100)throw new Error("trunc2 :: "+r);const s=Math.pow(10,r);return n.fixNegativeZero(Math.trunc(t*s)/s)}},acos:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: acos,"+n.getType(t));if(t<-1||t>1)throw new Error("acos2 :: "+r.toString(t));return Math.acos(t)}},acosh:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: acosh,"+n.getType(t));if(t<1)throw new Error("acosh2 :: "+t);return Math.acosh(t)}},asin:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: asin,"+n.getType(t));if(t<-1||t>1)throw new Error("asin2 :: "+r.toString(t));return Math.asin(t)}},asinh:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: asinh,"+n.getType(t));return Math.asinh(t)}},atan2:class extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(t)||n.isNull(r))return null;if(!n.isNumber(t))throw new Error("fn7 :: atan2,"+n.getType(t));if(!n.isNumber(r))throw new Error("fn7 :: atan2,"+n.getType(r));return Math.atan2(t,r)}},atan:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: atan,"+n.getType(t));return Math.atan(t)}},atanh:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: atanh,"+n.getType(t));if(t<-1||t>1)throw new Error("atanh2 :: "+r.toString(t));return Math.atanh(t)}},cos:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: cos,"+n.getType(t));if(n.isInfinite(t))throw new Error("cos2");return Math.cos(t)}},cosh:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: cosh,"+n.getType(t));return Math.cosh(t)}},sin:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: sin,"+n.getType(t));if(n.isInfinite(t))throw new Error("sin2");return Math.sin(t)}},sinh:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: sinh,"+n.getType(t));return Math.sinh(t)}},tan:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: tan,"+n.getType(t));if(n.isInfinite(t))throw new Error("tan2");return Math.tan(t)}},tanh:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(!n.isNumber(t))throw new Error("fn7 :: tanh,"+n.getType(t));return Math.tanh(t)}},toBoolean:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){return this.Expr.checkEvaluationLimits(this),r.toBoolean(this.arguments[0].evaluate(e))}},toString:class extends l{minArguments(){return 1}maxArguments(){return 1}optimize(){return this}evaluate(e){return this.Expr.checkEvaluationLimits(this),r.toString(this.arguments[0].evaluate(e))}},toNumber:class extends l{minArguments(){return 1}maxArguments(){return 1}optimize(){return this}evaluate(e){return this.Expr.checkEvaluationLimits(this),r.toNumber(this.arguments[0].evaluate(e))}},toDate:class extends l{minArguments(){return 1}maxArguments(){return 1}optimize(){return this}evaluate(e){return this.Expr.checkEvaluationLimits(this),r.toDate(this.arguments[0].evaluate(e))}},join:A,call:class extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){throw this.Expr.checkEvaluationLimits(this),new Error("general2 :: call")}},not:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){return this.Expr.checkEvaluationLimits(this),!r.toBoolean(this.arguments[0].evaluate(e))}},let:w,map:class extends l{minArguments(){return 2}maxArguments(){return 2}optimize(){for(let e=0;e<this.arguments.length;e++)this.arguments[e]=this.arguments[e].optimize();return this}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(n.isArray(t))return t.map((t=>{const r=Object.assign({},e);return r.item=t,this.arguments[1].evaluate(r)}));throw new Error("fn1 :: map,"+n.getType(t))}localVariableList(){return["item"]}},filter:class extends l{minArguments(){return 2}maxArguments(){return 2}optimize(){for(let e=0;e<this.arguments.length;e++)this.arguments[e]=this.arguments[e].optimize();return this}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(n.isArray(t)){const n=[];return t.forEach((t=>{const s=Object.assign({},e);s.item=t,r.toBoolean(this.arguments[1].evaluate(s))&&n.push(t)})),n}throw new Error("fn1 :: filter,"+n.getType(t))}localVariableList(){return["item"]}},reduce:class extends l{minArguments(){return 3}maxArguments(){return 3}optimize(){for(let e=0;e<this.arguments.length;e++)this.arguments[e]=this.arguments[e].optimize();return this}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(n.isArray(t)){let r=this.arguments[2].evaluate(e);return t.forEach((t=>{const n=Object.assign({},e);n.item=t,n.value=r,r=this.arguments[1].evaluate(n)})),r}throw new Error("fn1 :: reduce,"+n.getType(t))}localVariableList(){return["value","item"]}},range:class extends l{minArguments(){return 2}maxArguments(){return 3}evaluate(e){this.Expr.checkEvaluationLimits(this);let t=this.arguments[0].evaluate(e);const r=this.arguments[1].evaluate(e);let s=1;if(this.arguments.length>2&&(s=this.arguments[2].evaluate(e)),!n.isNumber(t))throw new Error("fn2 :: range,1st,"+n.getType(t));if(!n.is32BitInteger(t))throw new Error("fn3 :: range,1st");if(!n.isNumber(r))throw new Error("fn2 :: range,2nd,"+n.getType(r));if(!n.is32BitInteger(r))throw new Error("fn3 :: range,2nd");if(!n.isNumber(s))throw new Error("fn2 :: range,3rd,"+n.getType(s));if(!n.is32BitInteger(s))throw new Error("fn3 :: range,3rd");if(0===s)throw new Error("range7");const i=Math.max(Math.ceil((r-t)/s),0),a=Array(i);for(let e=0;e<i;e++,t+=s)a[e]=t;return a}},count:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isArray(t))return t.length;throw new Error("fn1 :: count,"+n.getType(t))}},reverse:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(n.isArray(t))return[...t].reverse();throw new Error("fn1 :: reverse,"+n.getType(t))}},merge:class extends l{minArguments(){return 1}maxArguments(){return 20}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=[];for(const r of this.arguments){const s=r.evaluate(e);if(n.isNull(s))return null;if(!n.isArray(s))throw new Error("fn1 :: merge,"+n.getType(s));t.push(...s)}return t}},sort:class extends l{minArguments(){return 1}maxArguments(){return 2}optimize(){for(let e=0;e<this.arguments.length;e++)this.arguments[e]=this.arguments[e].optimize();return this}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e);if(n.isNull(r))return null;if(n.isArray(r))return this.arguments.length>1?r.map((t=>{const r=Object.assign({},e);return r.item=t,{item:t,order:this.arguments[1].evaluate(r)}})).sort((function(e,r){return t.isGreater(e.order,r.order)?1:t.isLess(e.order,r.order)?-1:0})).map((e=>e.item)):r.sort((function(e,r){return t.isGreater(e,r)?1:t.isLess(e,r)?-1:0}));throw new Error("fn1 :: sort,"+n.getType(r))}localVariableList(){return["item"]}},slice:class extends l{minArguments(){return 2}maxArguments(){return 3}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);let r=this.arguments[1].evaluate(e);if(n.isNull(t)||n.isNull(r))return null;if(n.isArray(t)){if(!n.isNumber(r))throw new Error("slice3 :: "+n.getType(r));if(!n.isFinite(r)||n.hasFractionalPart(r))throw new Error("fn3 :: slice,2nd");let s;if(r<-t.length&&(r=-t.length),this.arguments.length>2){if(s=this.arguments[2].evaluate(e),n.isNull(s))return null;if(!n.isFinite(s)||n.hasFractionalPart(s))throw new Error("fn3 :: slice,3rd");if(s<=0)throw new Error("slice2 :: "+s)}else s=void 0;return t.slice(r,s?r+s:s)}throw new Error("fn1 :: slice,"+n.getType(t))}},indexOf:class extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e);if(n.isNull(r))return null;const s=this.arguments[1].evaluate(e);if(n.isArray(r)){let e=-1,n=0;for(const i of r){if(t.isEqual(i,s)){e=n;break}n++}return e}throw new Error("indexOf1 :: "+n.getType(r))}},unique:class extends l{minArguments(){return 1}maxArguments(){return 1}optimize(){return this}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e);if(n.isNull(r))return null;if(n.isArray(r)){const e=[];for(let n=0;n<r.length;n++){let s=!0;for(let i=0;i<e.length;i++)if(t.isEqual(r[n],e[i])){s=!1;break}s&&e.push(r[n])}return e}throw new Error("unique1 :: "+n.getType(r))}},type:class extends l{minArguments(){return 1}maxArguments(){return 1}optimize(){return this}evaluate(e){return this.Expr.checkEvaluationLimits(this),n.getType(this.arguments[0].evaluate(e))}},exists:class extends l{minArguments(){return 1}maxArguments(){return 1}constructor(e,t){if(super(e,t),!(this.arguments[0]instanceof $||this.arguments[0]instanceof L||this.arguments[0]instanceof S||this.arguments[0]instanceof j||this.arguments[0]instanceof M||this.arguments[0]instanceof D||this.arguments[0]instanceof C||this.arguments[0]instanceof P||this.arguments[0]instanceof o))throw new Error("exists1");(this.arguments[0]instanceof P||this.arguments[0]instanceof o)&&this.arguments[0].enableExistsMode()}optimize(){return this}evaluate(e){return this.Expr.checkEvaluationLimits(this),this.arguments[0]instanceof $||this.arguments[0]instanceof L||this.arguments[0]instanceof S||this.arguments[0]instanceof j||this.arguments[0]instanceof M||this.arguments[0]instanceof D||this.arguments[0]instanceof C||(this.arguments[0]instanceof u||(this.arguments[0]instanceof P||this.arguments[0]instanceof o)&&this.arguments[0].evaluateExists(e))}preEvaluate(e,t){try{if(this.arguments[0]instanceof o){const e=this.arguments[0].evaluateExists(t);return new u(new $(this.Expr,{type:"Boolean",value:e}))}return super.preEvaluate(e,t)}catch(e){if("undefined"===e.message)return new u(new $(this.Expr,{type:"Boolean",value:!1}));throw e}}},now:class extends l{minArguments(){return 0}maxArguments(){return 0}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=new Date;return t.setMilliseconds(0),t}},dateAdd:class extends l{minArguments(){return 3}maxArguments(){return 3}optimize(){return this.arguments[0]instanceof j?this.arguments[0].optimize():super.optimize()}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(r))return null;if(!n.isString(r))throw new Error("dateAdd1 :: "+n.getType(r));if(!["year","quarter","week","month","day","hour","minute","second","millisecond"].includes(r))throw new Error("dateAdd3");if(n.isNull(t))return null;if(n.isDate(t)){const s=this.arguments[2].evaluate(e);if(n.isNull(s))return null;if(n.isNumber(s)){if(Math.trunc(s)===s){if("year"===r)return this.addMonths(t,12*s);if("quarter"===r)return this.addMonths(t,3*s);if("week"===r)return this.addDays(t,7*s);if("month"===r)return this.addMonths(t,s);if("day"===r)return this.addDays(t,s);if("hour"===r)return this.addMinutes(t,60*s);if("minute"===r)return this.addMinutes(t,s);if("second"===r)return this.addMilliseconds(t,1e3*s);if("millisecond"===r)return this.addMilliseconds(t,s);throw new Error("dateAdd3")}throw new Error("dateAdd4")}throw new Error("dateAdd4")}throw new Error("dateAdd2")}addMonths(e,t){const r=new Date(e),n=r.getUTCDate();return r.setUTCMonth(r.getUTCMonth()+t),r.getUTCDate()!==n&&r.setUTCDate(0),r}addDays(e,t){const r=new Date(e);return r.setUTCDate(r.getUTCDate()+t),r}addMinutes(e,t){return this.addMilliseconds(e,1e3*t*60)}addMilliseconds(e,t){return new Date(+e+t)}},dateSubtract:class extends l{minArguments(){return 3}maxArguments(){return 3}optimize(){return this.arguments[0]instanceof j?this.arguments[0].optimize():super.optimize()}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(r))return null;if(!n.isString(r))throw new Error("dateSubtract1 :: "+n.getType(r));if(!["year","quarter","week","month","day","hour","minute","second","millisecond"].includes(r))throw new Error("dateSubtract3");if(n.isNull(t))return null;if(n.isDate(t)){const s=this.arguments[2].evaluate(e);if(n.isNull(s))return null;if(n.isNumber(s)){if(Math.trunc(s)===s){if("year"===r)return this.subtractMonths(t,12*s);if("quarter"===r)return this.subtractMonths(t,3*s);if("week"===r)return this.subtractDays(t,7*s);if("month"===r)return this.subtractMonths(t,s);if("day"===r)return this.subtractDays(t,s);if("hour"===r)return this.subtractMinutes(t,60*s);if("minute"===r)return this.subtractMinutes(t,s);if("second"===r)return this.subtractMilliseconds(t,1e3*s);if("millisecond"===r)return this.subtractMilliseconds(t,s);throw new Error("dateSubtract3")}throw new Error("dateSubtract4")}throw new Error("dateSubtract4")}throw new Error("dateSubtract2")}subtractMonths(e,t){const r=new Date(e),n=r.getUTCDate();return r.setUTCMonth(r.getUTCMonth()-t),r.getUTCDate()!==n&&r.setUTCDate(0),r}subtractDays(e,t){const r=new Date(e);return r.setUTCDate(r.getUTCDate()-t),r}subtractMinutes(e,t){return this.subtractMilliseconds(e,1e3*t*60)}subtractMilliseconds(e,t){return new Date(+e-t)}},length:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isString(t))return[...t].length;throw new Error("fn6 :: length,"+n.getType(t))}},substr:class extends l{minArguments(){return 1}maxArguments(){return 3}constructor(e,t){1===(t=[...t]).length&&t.push({type:"Number",value:0}),2===t.length&&t.push({type:"Number",value:n.INT32_RANGE}),super(e,t)}evaluate(e){this.Expr.checkEvaluationLimits(this);let t=this.arguments[0].evaluate(e);const s=this.arguments[1].evaluate(e),i=this.arguments[2].evaluate(e);if(n.isNumber(t)||n.isBoolean(t))t=r.toString(t);else{if(n.isNull(t))return"";if(!n.isString(t)&&!n.isDate(t))throw new Error("convert1 :: "+n.getType(t)+",string")}if(!n.isNumber(s))throw new Error("fn2 :: substr,2nd,"+n.getType(s));if(!n.is32BitInteger(s))throw new Error("fn3 :: substr,2nd");if(!n.isNumber(i))throw new Error("fn2 :: substr,3rd,"+n.getType(i));if(!n.is32BitInteger(i))throw new Error("fn3 :: substr,3rd");if(s<0)throw new Error("substr3");if(i<0)throw new Error("substr5");return n.isDate(t)&&(t=r.toString(t)),[...t].slice(s,s+i).join("")}},locate:class extends l{minArguments(){return 2}maxArguments(){return 3}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(t))return null;if(!n.isString(t))throw new Error("fn5 :: locate,1st,"+n.getType(t));if(!n.isString(r))throw new Error("fn5 :: locate,2nd,"+n.getType(r));let s=0;return this.arguments.length>2&&(s=this.arguments[2].evaluate(e)),function(e,t,r=0){const n=[...e],s=[...t].length;for(let e=r;e<=n.length-s;e++)if(n.slice(e,e+s).join("")===t)return e;return-1}(t,r,s)}},trim:O,trimStart:class extends l{minArguments(){return 1}maxArguments(){return 1}trimStart(e,t){let r=0,n=e.length;for(;r<n&&t.indexOf(e[r])>=0;)++r;return r>0||n<e.length?e.substring(r,n):e}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(n.isString(t))return this.trimStart(t,O.WHITESPACE);throw new Error("fn6 :: trimStart,"+n.getType(t))}},trimEnd:class extends l{minArguments(){return 1}maxArguments(){return 1}trimEnd(e,t){let r=e.length;for(;r>0&&t.indexOf(e[r-1])>=0;)--r;return r<e.length?e.substring(0,r):e}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(n.isString(t))return this.trimEnd(t,O.WHITESPACE);throw new Error("fn6 :: trimEnd,"+n.getType(t))}},split:class extends l{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(t)||n.isNull(r))return null;if(!n.isString(t))throw new Error("fn5 :: split,1st,"+n.getType(t));if(!n.isString(r))throw new Error("fn5 :: split,2nd,"+n.getType(r));if(""===r)throw new Error("split3");return t.split(r)}},replace:class extends l{minArguments(){return 3}maxArguments(){return 3}optimize(){for(let e=0;e<this.arguments.length;e++)this.arguments[e]=this.arguments[e].optimize();return this}evaluate(e){this.Expr.checkEvaluationLimits(this);let t=this.arguments[0].evaluate(e);const r=this.arguments[1].evaluate(e),s=this.arguments[2].evaluate(e);if(!n.isNull(t)&&!n.isString(t))throw new Error("fn5 :: replace,1st,"+n.getType(t));if(!n.isNull(r)&&!n.isString(r))throw new Error("fn5 :: replace,2nd,"+n.getType(r));if(!n.isNull(s)&&!n.isString(s))throw new Error("fn5 :: replace,3rd,"+n.getType(s));return n.isNull(t)||n.isNull(r)||n.isNull(s)?null:t.replace(r,s)}},replaceAll:class extends l{minArguments(){return 3}maxArguments(){return 3}optimize(){for(let e=0;e<this.arguments.length;e++)this.arguments[e]=this.arguments[e].optimize();return this}evaluate(e){this.Expr.checkEvaluationLimits(this);let t=this.arguments[0].evaluate(e);const r=this.arguments[1].evaluate(e),s=this.arguments[2].evaluate(e);if(!n.isNull(t)&&!n.isString(t))throw new Error("fn5 :: replaceAll,1st,"+n.getType(t));if(!n.isNull(r)&&!n.isString(r))throw new Error("fn5 :: replaceAll,2nd,"+n.getType(r));if(!n.isNull(s)&&!n.isString(s))throw new Error("fn5 :: replaceAll,3rd,"+n.getType(s));if(n.isNull(t)||n.isNull(r)||n.isNull(s))return null;let i,a=t,o=0;for(;i=a.indexOf(r,o),!(i<0);)a=a.substr(0,i)+s+a.substr(i+r.length),o=i+s.length;return a}},lower:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(n.isString(t))return t.toLowerCase();throw new Error("fn6 :: lower,"+n.getType(t))}},upper:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(n.isString(t))return t.toUpperCase();throw new Error("fn6 :: upper,"+n.getType(t))}},regexTest:_,regexMatch:class extends l{minArguments(){return 2}maxArguments(){return 3}optimize(){if(this.arguments[1]=this.arguments[1].optimize(),this.arguments[1]instanceof u&&!n.isNull(this.arguments[1].result)&&!n.isString(this.arguments[1].result))throw new Error("fn4 :: regexMatch,2nd");return this}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(t))return null;if(!n.isString(t))throw new Error("fn4 :: regexMatch,1st");if(n.isNull(r))return null;if(!n.isString(r))throw new Error("fn4 :: regexMatch,2nd");let s,i="";if(this.arguments.length>2){if(!(this.arguments[2]instanceof L))throw new Error("regexMatch3");if(i=this.arguments[2].evaluate(e),!_.validateFlags(i))throw new Error("regexMatch4")}try{s=new RegExp(r,i+"u")}catch(e){throw new Error("regexMatch3")}const a=s.exec(t);return a?{match:a[0],idx:a.index,captures:a.slice(1).map((e=>void 0===e?null:e))}:null}},regexMatchAll:class extends l{minArguments(){return 2}maxArguments(){return 3}optimize(){if(this.arguments[1]=this.arguments[1].optimize(),this.arguments[1]instanceof u&&!n.isNull(this.arguments[1].result)&&!n.isString(this.arguments[1].result))throw new Error("fn4 :: regexMatchAll,2nd");return this}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e),r=this.arguments[1].evaluate(e);if(n.isNull(t))return[];if(!n.isString(t))throw new Error("fn4 :: regexMatchAll,1st");if(n.isNull(r))return[];if(!n.isString(r))throw new Error("fn4 :: regexMatchAll,2nd");let s,i="";if(this.arguments.length>2){if(!(this.arguments[2]instanceof L))throw new Error("regexMatchAll3");if(i=this.arguments[2].evaluate(e),!_.validateFlags(i))throw new Error("regexMatchAll4")}try{s=new RegExp(r,i+"ug")}catch(e){throw new Error("regexMatchAll3")}const a=[];let o;for(;null!==(o=s.exec(t));)a.push({match:o[0],idx:o.index,captures:o.slice(1).map((e=>void 0===e?null:e))});return a}},objectToArray:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(n.isObject(t)){const e=[];for(const r in t)e.push({k:r,v:t[r]});return e}throw new Error("objectToArray1 :: "+n.getType(t))}},arrayToObject:class extends l{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(e);if(n.isNull(t))return null;if(n.isArray(t)){const e={};let r=null;for(const s of t){if("array"===r){if(!n.isArray(s))throw new Error("arrayToObject5 :: array,"+n.getType(s))}else if("object"===r){if(!n.isObject(s))throw new Error("arrayToObject5 :: object,"+n.getType(s))}else if(n.isArray(s))r="array";else{if(!n.isObject(s))throw new Error("arrayToObject2 :: "+n.getType(s));r="object"}if("array"===r){if(2!==s.length)throw new Error("arrayToObject4 :: "+s.length);if(!n.isString(s[0]))throw new Error("arrayToObject3 :: "+n.getType(s[0]));e[s[0]]=s[1]}else if("object"===r){const t=Object.keys(s).length;if(2!==t)throw new Error("arrayToObject7 :: "+t);if(!s.hasOwnProperty("k")||!s.hasOwnProperty("v"))throw new Error("arrayToObject8");if(!n.isString(s.k))throw new Error("arrayToObject6 :: "+n.getType(s.k));e[s.k]=s.v}}return e}throw new Error("arrayToObject1 :: "+n.getType(t))}}},z.UNARY_OPERATORS={"+":N,"-":T},z.BINARY_OPERATORS={"&":A,"+":N,"-":T,"*":y,"/":b,"%":x,"==":c,"!=":m,">":p,">=":f,"<":g,"<=":d,or:v,and:E,"??":k,in:h},z.LIMIT_MODE_NONE=0,z.LIMIT_MODE_10K=1,z.LIMIT_MODE_1M=2;const R=1,B=Math.max(0,...Object.keys(z.UNARY_OPERATORS).map((e=>e.length))),U=Math.max(0,...Object.keys(z.BINARY_OPERATORS).map((e=>e.length)));function Y(e){return e>=48&&e<=57}function q(e){var t;return(null===(t=z.BINARY_OPERATORS[e])||void 0===t?void 0:t.binaryOperatorPrecedence)||0}function F(e){var t;return(null===(t=z.BINARY_OPERATORS[e])||void 0===t?void 0:t.rightAssociative)||!1}function G(e){return e>=65&&e<=90||e>=97&&e<=122||["$","_"].includes(String.fromCharCode(e))}function V(e){return G(e)||"@"===String.fromCharCode(e)}function H(e){return G(e)||Y(e)}class J{constructor(e){this.expr=e,this.index=0}get char(){return this.expr.charAt(this.index)}get code(){return this.expr.charCodeAt(this.index)}throwError(e,t){throw new Error(e+" at character "+(null!=t?t:this.index))}gobbleSpaces(){let e=this.code;for(;32===e||9===e||10===e||13===e;)e=this.expr.charCodeAt(++this.index);this.gobbleComment()}gobbleComment(){if(47===this.code){let e=this.expr.charCodeAt(this.index+1);if(47===e){for(this.index++;10!==e&&!isNaN(e);)e=this.expr.charCodeAt(++this.index);this.gobbleSpaces()}else if(42===e){for(this.index+=2;!isNaN(e);)if(e=this.expr.charCodeAt(this.index++),42===e&&(e=this.expr.charCodeAt(this.index++),47===e))return void this.gobbleSpaces();this.throwError("parse1")}}}parse(){const e=this.gobbleExpressions();if(0===e.length)return null;if(1===e.length)return e[0];return{type:"CallExpression",arguments:[{type:"ObjectExpression",properties:e.slice(0,e.length-1).map((e=>("BinaryExpression"===e.type&&"="===e.operator||this.throwError("parse18",e.location[0]),"Identifier"!==e.left.type&&this.throwError("parse19",e.left.location[0]),e.left=e.left,{key:e.left.name,value:e.right,location:e.left.location}))),location:[0,0]},e[e.length-1]],callee:"let",location:[0,0]}}gobbleExpressions(){let e,t=[];for(;this.index<this.expr.length;)e=this.gobbleExpression(),e&&t.push(e),59!==this.code?this.index<this.expr.length&&this.throwError("parse2 :: "+this.char):this.index++;return t}gobbleExpression(){const e=this.gobbleBinaryExpression();return this.gobbleSpaces(),e}gobbleBinaryOp(){this.gobbleSpaces();let e=this.expr.substr(this.index,U),t=e.length;for(;t>0;){if((z.BINARY_OPERATORS.hasOwnProperty(e)||"="==e)&&(!V(this.code)||this.index+e.length<this.expr.length&&!H(this.expr.charCodeAt(this.index+e.length))))return this.index+=t,e;e=e.substr(0,--t)}return!1}gobbleBinaryExpression(){let e,t,r,n,s,i,a,o;const u=this.gobbleToken();if(!u)return u;if(t=this.gobbleBinaryOp(),!t)return u;for(s={value:t,prec:q(t),location:[this.index-t.length,this.index],right_a:F(t)},i=this.gobbleToken(),i||this.throwError("parse3 :: "+t),n=[u,s,i];t=this.gobbleBinaryOp();){r=q(t),s={value:t,prec:r,location:[this.index-t.length,this.index],right_a:F(t)},o=t;const i=e=>s.right_a&&e.right_a?r>e.prec:r<=e.prec;for(;n.length>2&&i(n[n.length-2]);){const e=n.pop(),t=n.pop(),r=n.pop();n.push({type:"BinaryExpression",operator:t.value,left:r,right:e,location:t.location})}e=this.gobbleToken(),e||this.throwError("parse3 :: "+o),n.push(s,e)}for(a=n.length-1,e=n[a];a>1;)e={type:"BinaryExpression",operator:n[a-1].value,left:n[a-2],right:e,location:n[a-1].location},a-=2;return e}gobbleToken(){this.gobbleSpaces();const e=this.code;let t;if(Y(e))t=this.gobbleNumericLiteral();else if(39===e||34===e||47===e)t=this.gobbleStringLiteral();else if(35===e)t=this.gobbleDateLiteral();else if(91===e)t=this.gobbleArray();else if(123===e)t=this.gobbleObjectExpression();else{let r=this.expr.substr(this.index,B),n=r.length;for(;n>0;){if(z.UNARY_OPERATORS.hasOwnProperty(r)&&(!V(this.code)||this.index+r.length<this.expr.length&&!H(this.expr.charCodeAt(this.index+r.length)))){this.index+=n;const e=[this.index-n,this.index],t=this.gobbleToken();return t||this.throwError("parse4"),{type:"UnaryExpression",operator:r,argument:t,location:e}}r=r.substr(0,--n)}V(e)?(t=this.gobbleIdentifier(),"true"===t.name||"false"===t.name?t={type:"Boolean",value:"true"===t.name,location:t.location}:"null"===t.name?t={type:"Null",location:t.location}:"Infinity"===t.name?t={type:"Number",value:"Infinity",location:t.location}:"NaN"===t.name&&(t={type:"Number",value:"NaN",location:t.location})):40===e&&(t=this.gobbleGroup()||t)}return this.gobbleTokenProperty(t)}gobbleTokenProperty(e){this.gobbleSpaces();let t=this.code;for(;46===t||91===t||40===t;){if(e||this.throwError("parse2 :: "+this.char),this.index++,91===t){const r=this.gobbleExpression();this.gobbleSpaces(),t=this.code,93!==t&&this.throwError("parse8 :: ["),r||this.throwError("parse2 :: "+this.char),this.index++,e={type:"MemberExpression",object:e,property:r,location:[e.location[0],this.index]}}else if(46===t){this.gobbleSpaces();const t=this.gobbleIdentifier();e={type:"MemberExpression",object:e,property:{type:"String",value:t.name,location:t.location},location:[e.location[0],t.location[1]]}}else 40===t&&("Identifier"===e.type?(z.FUNCTIONS[e.name]||this.throwError("parse14 :: "+e.name),e={type:"CallExpression",arguments:this.gobbleArguments(41),callee:e.name,location:e.location}):"MemberExpression"===e.type&&"String"===e.property.type?(z.FUNCTIONS[e.property.value]||this.throwError("parse14 :: "+e.property.value),e={type:"CallExpression",arguments:[e.object,...this.gobbleArguments(41)],callee:e.property.value,location:e.property.location}):this.throwError("parse13"));this.gobbleSpaces(),t=this.code}return 63===t&&63!==this.expr.charCodeAt(this.index+1)&&(this.index++,e={type:"UnaryExpression",operator:"?",argument:e,location:[this.index-1,this.index]}),e}gobbleNumericLiteral(){let e="";const t=this.index;for(;Y(this.code);)e+=this.expr.charAt(this.index++);if(46===this.code)for(e+=this.expr.charAt(this.index++);Y(this.code);)e+=this.expr.charAt(this.index++);let r=this.char;if("e"===r||"E"===r){for(e+=this.expr.charAt(this.index++),r=this.char,"+"!==r&&"-"!==r||(e+=this.expr.charAt(this.index++));Y(this.code);)e+=this.expr.charAt(this.index++);Y(this.expr.charCodeAt(this.index-1))||this.throwError("parse15 :: "+e+this.char)}const n=this.code;V(n)?this.throwError("parse6 :: "+e+this.char):(46===n||1===e.length&&46===e.charCodeAt(0))&&this.throwError("parse2 :: .");const s=parseFloat(e);return s>Number.MAX_VALUE&&this.throwError("parse7"),{type:"Number",value:s,location:[t,this.index]}}gobbleStringLiteral(){let e="";const t=this.index,r=this.expr.charAt(this.index++);let n=!1;for(;this.index<this.expr.length;){let t=this.expr.charAt(this.index++);if(t===r){n=!0;break}if("\\"===t)if(t=this.expr.charAt(this.index++),"/"===r)e+="\\"+t;else switch(t){case"n":e+="\n";break;case"r":e+="\r";break;case"t":e+="\t";break;case"b":e+="\b";break;case"f":e+="\f";break;case"v":e+="\v";break;default:e+=t}else e+=t}return n||this.throwError("parse16 :: "+e),{type:"String",value:e,location:[t,this.index]}}gobbleDateLiteral(){const e=this.index,t=this.expr.indexOf("#",this.index+1)+1,n=this.expr.substring(e+1,t-1);let s;try{s=r.toDate(n)}catch(e){this.throwError("parse17")}return this.index=t,{type:"Date",value:s.toISOString(),location:[e,t]}}gobbleIdentifier(){let e=this.code;const t=this.index;for(V(e)?this.index++:this.throwError("parse2 :: "+this.char);this.index<this.expr.length&&(e=this.code,H(e));)this.index++;const r=this.expr.slice(t,this.index);return"@"===r[0]?{type:"Identifier",column:!0,name:r.slice(1),location:[t,this.index]}:{type:"Identifier",column:!1,name:r,location:[t,this.index]}}gobbleArguments(e){const t=[];let r=!1,n=0;for(;this.index<this.expr.length;){this.gobbleSpaces();let s=this.code;if(s===e){r=!0,this.index++,41===e&&n&&n>=t.length&&this.throwError("parse2 :: "+String.fromCharCode(e));break}if(44===s)this.index++,n++,n!==t.length&&this.throwError("parse2 :: ,");else if(t.length!==n)this.throwError("parse5 :: ,");else{const e=this.gobbleExpression();e||this.throwError("parse5 :: ,"),t.push(e)}}return r||this.throwError("parse5 :: "+String.fromCharCode(e)),t}gobbleGroup(){this.index++;const e=this.gobbleExpression();if(41===this.code)return this.index++,e;this.throwError("parse8 :: (")}gobbleArray(){const e=this.index;this.index++;return{type:"ArrayExpression",elements:this.gobbleArguments(93),location:[e,this.index]}}gobbleObjectExpression(){const e=this.index;this.index++;const t=[];let r=!1;for(;!isNaN(this.code);){if(this.gobbleSpaces(),125===this.code){this.index++,r=!0;break}if(t.length)if(44===this.code){if(this.index++,this.gobbleSpaces(),125===this.code){this.index++,r=!0;break}}else this.throwError("parse9 :: ,");const e=this.gobbleExpression();if(!e)break;let n,s=e.location;if("Identifier"===e.type?n=e.name:"String"===e.type?n=e.value:"Null"===e.type?n="null":this.throwError("parse10"),this.gobbleSpaces(),58===this.code){this.index++;const e=this.gobbleExpression();e||this.throwError("parse11"),t.push({key:n,value:e,location:s}),this.gobbleSpaces()}else this.throwError("parse12")}if(r)return this.gobbleTokenProperty({type:"ObjectExpression",properties:t,location:[e,this.index]});this.throwError("parse9 :: }")}}function W(e){try{return{version:R,code:e,source:new J(e).parse(),error:null}}catch(t){let r=t.message,n=0;const s=t.message.split(" at character ");return s.length>1&&(r=s[0],n=1*s[1]),{version:R,code:e,source:null,error:{message:r,character:n}}}}function Z(e){"formula"!==e.getMode({},"formula").name&&e.defineMode("formula",(function(e,t){var r=/[\w$\xa1-\uffff]/,n=/[+\-*&%=<>!\/?]/;function s(e,t){if(e.sol()?t.sol=!0:e.pos>e.indentation()&&(t.sol=!1),e.eatSpace(),!e.current().length){var o=e.next();if('"'==o||"'"==o)return t.tokenize=i(o),t.tokenize(e,t);if("/"==o){if(e.eat("*"))return t.tokenize=a,a(e,t);if(e.eat("/"))return e.skipToEnd(),"comment";{let r=!1;if((null===t.previousToken||"operator"===t.previousToken||"comma"===t.previousToken||"parentheses-open"===t.previousToken)&&(r=!0),r)return t.tokenize=i(o),t.tokenize(e,t)}}if("#"==o)return t.tokenize=function(e,t){for(var r;r=e.next();)if("#"==r){t.tokenize=s;break}return"date"},t.tokenize(e,t);if("("===o||"["===o||"{"===o)return`parentheses-open ${{"(":"parentheses-type-a","[":"parentheses-type-b","{":"parentheses-type-c"}[o]}`;if(")"===o||"]"===o||"}"===o)return`parentheses-close ${{")":"parentheses-type-a","]":"parentheses-type-b","}":"parentheses-type-c"}[o]}`;if("0"==o&&e.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/))return"number";if(/\d/.test(o))return e.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/),"number";if(n.test(o))return e.eatWhile(n),"operator";if("@"===o)return e.eatWhile(r),"column";if(r.test(o)){e.eatWhile(r);const t=e.current();return e.eatSpace(),"("===e.peek()&&z.FUNCTIONS[t]?"function":z.BINARY_OPERATORS[t]?"operator":"variable"}return","===o?"comma":void 0}}function i(e){return function(t,r){for(var n,i=!1;n=t.next();){if(n==e&&!i){r.tokenize=s;break}i=!i&&"\\"==n}return"string"}}function a(e,t){for(var r,n=!1;r=e.next();){if("/"==r&&n){t.tokenize=s;break}n="*"==r}return"comment"}return{startState:function(e){return{tokenize:s,previousToken:null,baseIndent:e||0,level:0,sol:!1,eol:!1}},token:function(e,t){const r=t.tokenize(e,t);t.eol=e.eol();const n=e.current();return"("===n||"["===n||"{"===n?t.eol&&t.level++:")"!==n&&"]"!==n&&"}"!==n||t.sol&&t.level--,r&&(t.previousToken=r.split(" ")[0]),r},indent:function(t,r){let n=t.level;return/^[\}\]\)]/.test(r)&&(n-=1),t.baseIndent+n*e.indentUnit},electricChars:"}])"}}))}function K(e,t){let r=0,n=t;for(let s=0;s<t;s++)"\n"===e[s]&&(r++,n=t-s-1);return{ch:n,line:r}}class X{static evaluate(e,t){const r=[];X.patchExpression(r),new z(e,z.LIMIT_MODE_1M).evaluate(t),X.restoreExpression();const n=[];for(const e of r)n[e.location[0]]=n[e.location[0]]||[],n[e.location[0]].push(e);const s=[];for(const e of n)e&&s.push(...e);const i={};for(const e of s){const t=`${e.location[0]}-${e.location[1]}`;i[t]=i[t]||[],i[t].push(e.result)}return i}static patchExpression(e){z.prototype.__makeNode=z.prototype.makeNode,z.prototype.makeNode=(...e)=>{const t=z.prototype.__makeNode(...e);return t.__source=e[0],t};for(const t of[...Object.values(z.BINARY_OPERATORS),...Object.values(z.UNARY_OPERATORS),...Object.values(z.FUNCTIONS),z.NODES.Identifier])X.patchNode(t,e);z.NODES.ObjectExpression.prototype.__evaluate=z.NODES.ObjectExpression.prototype.evaluate,z.NODES.ObjectExpression.prototype.evaluate=function(...t){const r=this.__source;for(const t in this.object)if(!this.object[t].hasOwnProperty("evaluate")){const n=this.object[t].evaluate;this.object[t].evaluate=function(...s){const i=n.call(this,...s);return e.push({location:r.properties.find((e=>e.key===t)).location,result:JSON.parse(JSON.stringify(i))}),i}}return z.NODES.ObjectExpression.prototype.__evaluate.call(this,...t)},z.NODES.MemberExpression.prototype.__evaluate=z.NODES.MemberExpression.prototype.evaluate,z.NODES.MemberExpression.prototype.evaluate=function(...t){const r=z.NODES.MemberExpression.prototype.__evaluate.call(this,...t);return"Number"!==this.__source.property.type&&"String"!==this.__source.property.type||e.push({location:[this.__source.property.location[0],this.__source.property.location[1]],result:JSON.parse(JSON.stringify(r))}),r}}static patchNode(e,t){e.prototype.__evaluate||(e.prototype.__evaluate=e.prototype.evaluate,e.prototype.evaluate=function(...r){if(e===w){const n=this.__source;for(const e in this.arguments[0].object)if(!this.arguments[0].object[e].hasOwnProperty("evaluate")){const r=this.arguments[0].object[e].evaluate;this.arguments[0].object[e].evaluate=function(...s){const i=r.call(this,...s);return t.push({location:n.arguments[0].properties.find((t=>t.key===e)).location,result:JSON.parse(JSON.stringify(i))}),i}}return e.prototype.__evaluate.call(this,...r)}{const n=e.prototype.__evaluate.call(this,...r);return t.push({location:this.__source.location,result:JSON.parse(JSON.stringify(n))}),n}})}static restoreExpression(){z.prototype.makeNode=z.prototype.__makeNode,delete z.prototype.__makeNode;for(const e of[...Object.values(z.BINARY_OPERATORS),...Object.values(z.UNARY_OPERATORS),...Object.values(z.FUNCTIONS),z.NODES.Identifier])X.restoreNode(e);z.NODES.ObjectExpression.prototype.evaluate=z.NODES.ObjectExpression.prototype.__evaluate,delete z.NODES.ObjectExpression.prototype.__evaluate,z.NODES.MemberExpression.prototype.evaluate=z.NODES.MemberExpression.prototype.__evaluate,delete z.NODES.MemberExpression.prototype.__evaluate}static restoreNode(e){e.prototype.__evaluate&&(e.prototype.evaluate=e.prototype.__evaluate,delete e.prototype.__evaluate)}static enableAnalyzer(e,t,r){e.setOption("readOnly","nocursor");const n=e.getDoc(),s=e.getDoc().getValue(),i=[];for(const e in t){const t=e.split("-").map((e=>parseInt(e)));i.push(n.markText(K(s,t[0]),K(s,t[1]),{className:"analyzer",attributes:{"data-location":e},startStyle:"analyzer-start",endStyle:"analyzer-end"}))}e.on("mousedown",((e,s)=>{const a=e.coordsChar({left:s.clientX,top:s.clientY});for(const e of n.getAllMarks())0===e.className.indexOf("analyzer-active")&&e.clear();for(let e of i){const s=e.find();if(s&&a.line>=s.from.line&&a.line<=s.to.line&&(a.line!==s.from.line&&a.line!==s.to.line||a.ch>=s.from.ch&&a.ch<=s.to.ch))return n.markText(s.from,s.to,{className:"analyzer-active"}),void r(t[e.attributes["data-location"]])}r(null)}))}static disableAnalyzer(e){e.setOption("readOnly",!1);const t=e.getDoc();for(const e of t.getAllMarks())0===e.className.indexOf("analyzer")&&e.clear()}}function Q(e){return null!=e?e.toString().replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}function ee(e){return Q(e=JSON.stringify(e).slice(1,-1))}function te(e){return/^[A-Za-z_$][A-Za-z0-9_$]*$/.test(e)}function re(e,t){return`<span class="${t}">${Q(e)}</span>`}function ne(e){const t=e.target.closest(".sv-collapser");t&&(e.stopPropagation(),t.classList.toggle("sv-collapsed"));const r=e.target.closest(".sv-prop");if(r&&r.hasAttribute("data-copy")&&(e.stopPropagation(),!1!==function(e){if(window.clipboardData&&window.clipboardData.setData)return clipboardData.setData("Text",e);if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var t=document.createElement("textarea");t.textContent=e,t.style.position="fixed",document.body.appendChild(t),t.select();try{return document.execCommand("copy")}catch(e){return console.warn("Copy to clipboard failed.",e),!1}finally{document.body.removeChild(t)}}}(r.getAttribute("data-copy")))){const e=document.createElement("span");e.classList.add("expression-scope-viewer-copied"),e.innerText=s.scope_viewer.copied[this._lang].replace("%path%",r.getAttribute("data-copy")),document.body.append(e);const t=r.getBoundingClientRect(),n=e.getBoundingClientRect();e.style.top=`${Math.round(t.top-n.top-n.height)}px`,e.style.left=`${Math.round(t.left-n.left)}px`,window.requestAnimationFrame((function(){e.classList.add("sv-animated1"),setTimeout((function(){e.classList.add("sv-animated2"),setTimeout((function(){e.remove()}),600)}),600)}))}}"undefined"==typeof HTMLElement&&(global.HTMLElement=class{});class se extends HTMLElement{constructor(){super(),this._value="",this._lang="en",this._copyable=!1}static define(){void 0===customElements.get("expression-scope-viewer")&&customElements.define("expression-scope-viewer",se)}valueToHTML(e,t){const r=typeof e;return null===e?re("null","sv-null"):Array.isArray(e)?this.arrayToHTML(e,t):e instanceof Date?re(z.prettyPrint(e),"sv-date"):"object"===r?this.objectToHTML(e,t):"number"===r?re(e,"sv-num"):"string"!==r||8203!==e.charCodeAt(0)||isNaN(e.slice(1))?"string"===r?`<span class="sv-string">&quot;${ee(e)}&quot;</span>`:"boolean"===r?re(e,"sv-bool"):"":re(e.slice(1),"sv-num")}arrayToHTML(e,t){if(0===e.length)return"[ ]";let r="";for(let n=0;n<e.length;n++){const i=`${t}[${n}]`,a=Q(s.scope_viewer.copy_path[this._lang].replace("%path%",i));r+=`<li><span class="sv-index sv-prop" data-text="${n}" ${this._copyable?`title="${a}" data-copy="${Q(i)}"`:""}></span>`,r+='<span class="sv-index" data-text=": "></span>',r+=`${this.valueToHTML(e[n],i)}`,n<e.length-1&&(r+=","),r+="</li>"}return`<span class="sv-collapser"></span>[<ul class="sv-array sv-collapsible">${r}</ul>${`<span class="sv-collapsed-counter" data-text="…${e.length}"></span>`}]`}objectToHTML(e,t){let r=Object.keys(e).length;if(0===r)return"{ }";const n=`<span class="sv-collapsed-counter" data-text="…${r}"></span>`;let i="";for(const n in e){let a="",o=JSON.stringify(n).slice(1,-1);const u=te(n);a=u?t.length?`${t}.${o}`:o:`${t}["${o}"]`;const l=Q(s.scope_viewer.copy_path[this._lang].replace("%path%",a));i+=`<li><span class="sv-prop" ${this._copyable?`title="${l}" data-copy="${Q(a)}"`:""}>`,u||(i+="&quot;"),i+=ee(n),u||(i+="&quot;"),i+=`</span>: ${this.valueToHTML(e[n],a)}`,r>1&&(i+=","),i+="</li>",r--}return`<span class="sv-collapser"></span>{<ul class="sv-obj sv-collapsible">${i}</ul>${n}}`}set value(e){e!==this._value&&(this._value=e,this._lang=this.getAttribute("lang")||"en",this._copyable=null!==this.getAttribute("copyable"),this.innerHTML=this.valueToHTML(e,""),console.log("scope-view redraw"))}get value(){return this._value}connectedCallback(){this.addEventListener("click",ne,!1)}destroy(){}disconnectedCallback(){this.removeEventListener("click",ne)}}let ie=null;function ae(e,t){Z(ie),e.classList.add("theme-"+t.theme);const r=document.createElement("div");r.classList.add("expression-editor_container"),e.append(r),r.addEventListener("change",(e=>{e.stopPropagation()}));const n=document.createElement("div");r.append(n),n.classList.add("expression-editor_left-label");const i=document.createElement("div");n.append(i),i.classList.add("expression-editor_left-menu");const a=document.createElement("div");i.append(a),a.classList.add("expression-editor_fx-icon"),e._fxIcon=a;const o=document.createElement("div");i.append(o),o.classList.add("expression-editor_link-container"),e._leftMenu=i;const u=document.createElement("a");o.append(u),u.classList.add("expression-editor_link-element"),u.setAttribute("target","_blank"),u.innerText=s.editor.goto_playground[e._lang],a.addEventListener("click",(t=>{if(i.classList.contains("expandable"))if(i.classList.contains("expanded"))i.classList.remove("expanded");else{i.classList.add("expanded");const t=[s.editor.playground_href[e._lang],"?formula="+encodeURIComponent(e._currentValue),"&scope="+encodeURIComponent(z.prettyPrint(e._currentScope,""))].join("");u.setAttribute("href",t)}})),i.addEventListener("mouseleave",(e=>{i.classList.contains("expandable")&&i.classList.contains("expanded")&&i.classList.remove("expanded")}));const l=document.createElement("textarea");l.textContent=t.value,r.append(l);const h=ie.fromTextArea(l,{lineNumbers:!1,indentWithTabs:!1,indentUnit:2,tabSize:2,mode:"formula",theme:"formula",smartIndent:!0,electricChars:!0,scrollbarStyle:"overlay",extraKeys:{Tab:e=>{e.somethingSelected()?e.execCommand("indentMore"):e.execCommand("insertSoftTab")},"Shift-Tab":e=>e.execCommand("indentLess")}});h.setOption("viewportMargin",1/0),h.setSize(t.width||"100%",t.height||"auto"),function(e){function t(e){var t,r;const n=e.getDoc();for(const e of n.getAllMarks())0===e.className.indexOf("parentheses")&&e.clear();let s=[];const i=[],a=n.size;for(let o=0;o<a;o++){let a=e.getLineTokens(o);for(const u of a)if(0===(null===(t=u.type)||void 0===t?void 0:t.indexOf("parentheses-open")))s.push({type:u.type.match(/parentheses-type-([abc])/)[1],start:{line:o,ch:u.start},end:{line:o,ch:u.start+1}});else if(0===(null===(r=u.type)||void 0===r?void 0:r.indexOf("parentheses-close"))){const t={type:u.type.match(/parentheses-type-([abc])/)[1],start:{line:o,ch:u.start},end:{line:o,ch:u.start+1}};let r,a=[];for(const e of s.slice().reverse()){if(e.type===t.type){r=e,s=s.slice(0,s.indexOf(e));break}a.push(e)}if(r){for(const e of a)n.markText(e.start,e.end,{className:"parentheses-error"});if(n.markText(r.start,r.end,{className:`parentheses-${s.length+1}`}),n.markText(t.start,t.end,{className:`parentheses-${s.length+1}`}),0===e.getSelection().length){const n=e.getCursor(),s=n.line>r.start.line,a=n.line===r.start.line&&n.ch>=r.start.ch;if(s||a){const e=n.line<t.start.line,s=n.line===t.start.line&&n.ch<=t.start.ch+1;(e||s)&&i.push({open:r,close:t})}}}else n.markText(t.start,t.end,{className:"parentheses-error"})}}for(const e of s)n.markText(e.start,e.end,{className:"parentheses-error"});i.length&&(n.markText(i[0].open.start,i[0].open.end,{className:"parentheses-match"}),n.markText(i[0].close.start,i[0].close.end,{className:"parentheses-match"}),n.markText(i[0].open.start,i[0].close.end,{className:"parentheses-block"}))}e.on("cursorActivity",t),t(e)}(h);const c=document.createElement("div");function m(e){const t=e.getDoc(),r=W(t.getValue());if(null===r.error)return;const n=z.ErrorTranslator.toRussian("parse :: "+r.error.message);let s=0;const i=t.size;for(let t=0;t<i;t++){const i=e.getLine(t).length;if(!(s+i<r.error.character))return void p({line:t,ch:r.error.character-s},n);s+=i+1}p({line:0,ch:0},n)}function p(t,r){e.classList.add("has-error"),c.setAttribute("title",r),h.addWidget(t,c,!1)}let f;return c.classList.add("error-mark"),c.innerHTML='<svg width="13px" height="5px" viewBox="0 0 13 5" xmlns="http://www.w3.org/2000/svg">\n    <g stroke="#FF0000" stroke-width="0.5" fill="none" fill-rule="evenodd">\n        <polygon fill="#FF0000" transform="translate(6.5, 3.5) rotate(-315) translate(-6.5, -3.5) " points="2 8 2 3 6 3 6 -1 11 -1 11 0 7 0 7 4 3 4 3 8"></polygon>\n    </g>\n</svg>',h.on("change",(t=>{c.remove(),e.classList.remove("has-error"),clearTimeout(f),f=setTimeout((()=>m(t)),2e3)})),m(h),h}"undefined"==typeof HTMLElement&&(global.HTMLElement=class{});class oe extends HTMLElement{constructor(){super(),this.cm=null,this._currentValue="",this._delayedValue="",this._currentScope=null,this._delayedScope=null,this._lang="en",this.addEventListener("change",(e=>{e.target!==this&&e.stopPropagation()}))}static define(e){if(null===ie)ie=e,void 0===customElements.get("expression-editor")&&customElements.define("expression-editor",oe);else if(ie!==e)throw new Error("ScenarioEditor element is already defined with another CodeMirror")}set value(e){if(this.cm){if(this._currentValue!==e){const t=this.cm.getDoc(),r=t.scrollLeft,n=t.scrollTop;t.setValue(e),this.cm.scrollTo(r,n)}}else this._delayedValue=e}get value(){return this._currentValue}connectedCallback(){if(this.cm)return;const e=this._delayedValue||this.getAttribute("value")||"";this._lang=this.getAttribute("lang")||"en",this.cm=ae(this,{theme:this.getAttribute("theme")||"redactor",width:this.getAttribute("width")||"100%",height:this.getAttribute("height")||"auto",value:e}),this._currentValue=this.cm.getDoc().getValue(),this._delayedScope&&this.evaluate(this._delayedScope),this.cm.on("change",(e=>{this._currentValue=this.cm.getDoc().getValue(),this.dispatchEvent(new CustomEvent("change"))})),this.cm.on("focus",(e=>{this.dispatchEvent(new CustomEvent("focus"))})),this.cm.on("blur",(e=>{this.dispatchEvent(new CustomEvent("blur"))})),0===this.cm.display.wrapper.offsetWidth&&function e(){this.cm.display.wrapper.offsetWidth?this.cm.refresh():setTimeout(e.bind(this),100)}.bind(this)()}evaluate(e){if(!this.cm)return void(this._delayedScope=e);this._currentScope=e,this._fxIcon.removeAttribute("title"),this._leftMenu.classList.remove("expandable");const t=W(this._currentValue);if(t.error)return;const r=new z(t,z.LIMIT_MODE_10K).evaluate(e);r.error||(this._fxIcon.setAttribute("title",z.prettyPrint(r.result)),this._leftMenu.classList.add("expandable"))}enableAnalyzer(e,t){X.enableAnalyzer(this.cm,e,t)}disableAnalyzer(){X.disableAnalyzer(this.cm)}destroy(){this.cm.toTextArea(),this.innerHTML=""}disconnectedCallback(){}}return e.Expression=z,e.ExpressionAnalyzer=X,e.ExpressionEditorElement=oe,e.ExpressionScopeViewerElement=se,e.parseExpression=W,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
